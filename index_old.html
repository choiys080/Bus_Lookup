<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activity Check-In Portal</title>
    <meta name="description" content="Corporate activity selection and itinerary lookup portal">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@700;800;900&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            color: #0f172a;
        }

        h1,
        h2,
        h3,
        h4,
        .font-heading {
            font-family: 'Outfit', sans-serif;
        }

        .slide-in {
            animation: slideIn 0.4s ease-out forwards;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Timeline styling */
        .timeline-item {
            position: relative;
            padding-left: 2rem;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: 0.45rem;
            top: 1.5rem;
            width: 2px;
            height: calc(100% - 0.5rem);
            background: #e2e8f0;
        }

        .timeline-item:last-child::before {
            display: none;
        }

        .timeline-dot {
            position: absolute;
            left: 0;
            top: 0.25rem;
            width: 1rem;
            height: 1rem;
            border-radius: 50%;

            background: #00A97A;
            border: 3px solid white;
            box-shadow: 0 0 0 2px #00A97A;
        }

        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .shadow-premium {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.04), 0 4px 6px -2px rgba(0, 0, 0, 0.02), 0 20px 25px -5px rgba(0, 0, 0, 0.03);
        }

        .transition-soft {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Custom scrollbar for premium feel */
        ::-webkit-scrollbar {
            width: 5px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #e2e8f0;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #cbd5e1;
        }
    </style>
</head>

<body class="bg-slate-100 min-h-screen flex flex-col items-center p-4 sm:p-8">
    <div id="app"
        class="w-full max-w-md bg-white rounded-[3rem] shadow-premium border border-slate-200/60 min-h-[600px] flex flex-col relative overflow-hidden">
        <!-- Main Header: Sleek Corporate Branding -->
        <div
            class="bg-white/80 backdrop-blur-md px-8 py-7 flex justify-between items-center relative border-b border-slate-100/10 z-50">
            <div class="flex items-center gap-4">
                <div
                    class="w-11 h-11 bg-gradient-to-tr from-[#00A97A] to-[#00C896] rounded-2xl flex items-center justify-center shadow-lg shadow-[#00A97A]/20">
                    <i data-lucide="building-2" class="w-6 h-6 text-white"></i>
                </div>
                <div class="flex flex-col">
                    <span class="text-[10px] font-black text-[#00A97A] tracking-[0.25em] leading-tight mb-0.5">B.
                        BRAUN</span>
                    <span class="text-xs font-heading font-black text-slate-900 tracking-tight uppercase">Activity
                        Portal</span>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <div id="admin-trigger" onclick="toggleAdmin()"
                    class="group cursor-pointer bg-slate-50 hover:bg-slate-900 p-2.5 rounded-xl transition-soft border border-slate-100 shadow-sm hover:shadow-lg active:scale-95">
                    <i data-lucide="settings" id="admin-icon"
                        class="w-5 h-5 text-slate-400 group-hover:text-white transition-soft"></i>
                </div>
            </div>
        </div>

        <!-- Key Visual Banner: Premium Hero -->
        <!-- Geometric Accents -->
        <div class="absolute -top-10 -left-10 w-40 h-40 bg-[#00A97A]/10 rounded-full blur-3xl"></div>
        <div class="absolute -bottom-10 -right-10 w-40 h-40 bg-[#9E2AB5]/10 rounded-full blur-3xl"></div>

        <div class="p-8 relative min-h-[400px] flex flex-col" id="content-area">
            <!-- Loading View: Premium Sync -->
            <div id="loading-view" class="flex flex-col items-center justify-center py-24 space-y-8">
                <div class="relative">
                    <div class="w-16 h-16 border-[3px] border-slate-100 rounded-full"></div>
                    <div
                        class="absolute inset-0 w-16 h-16 border-[3px] border-[#00A97A] border-t-transparent rounded-full animate-spin">
                    </div>
                    <div class="absolute inset-x-0 -bottom-1 flex justify-center">
                        <div class="w-1.5 h-1.5 bg-[#00A97A] rounded-full animate-pulse"></div>
                    </div>
                </div>
                <div class="text-center space-y-2">
                    <p class="text-[10px] text-[#00A97A] font-black uppercase tracking-[0.3em] animate-pulse">
                        Establishing Secure Link</p>
                    <p class="text-[8px] text-slate-300 font-bold uppercase tracking-widest">B. BRAUN CLOUD SERVICES</p>
                </div>
            </div>

            <!-- Admin View: Sleek Dashboard -->
            <div id="admin-view" class="hidden slide-in space-y-8">
                <div class="text-center">
                    <h2 class="text-xl font-heading font-black text-slate-900 tracking-tight uppercase">Admin Dashboard
                    </h2>
                    <p class="text-[9px] text-slate-400 font-bold tracking-[0.2em] uppercase mt-1">Management Console
                    </p>
                </div>

                <!-- Compact Stats: Management Bar -->
                <div class="flex items-center gap-3 bg-slate-50 p-2 rounded-2xl border border-slate-100">
                    <div
                        class="flex-1 flex items-center justify-between px-4 py-3 bg-white rounded-xl border border-slate-50 shadow-sm">
                        <span
                            class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Registrations</span>
                        <span id="admin-total-count" class="text-sm font-black text-slate-900">0</span>
                    </div>
                    <div
                        class="flex-1 flex items-center justify-between px-4 py-3 bg-white rounded-xl border border-slate-100 shadow-sm">
                        <span class="text-[9px] font-black text-[#00A97A] uppercase tracking-widest">Checked-In</span>
                        <span id="admin-checked-count" class="text-sm font-black text-[#00A97A]">0</span>
                    </div>
                </div>


                <div class="">
                    <!-- Tabs & Sort: Unified Utility Bar -->
                    <div class="flex items-center justify-between mb-6 gap-4">
                        <div class="flex bg-slate-100 p-1 rounded-xl">
                            <button onclick="switchAdminTab('status')" id="tab-status-btn"
                                class="px-3 py-1.5 text-[9px] font-black uppercase tracking-widest rounded-lg transition-soft bg-white text-[#00A97A] shadow-sm">Status</button>
                            <button onclick="switchAdminTab('log')" id="tab-log-btn"
                                class="px-3 py-1.5 text-[9px] font-black uppercase tracking-widest rounded-lg transition-soft text-slate-400 hover:text-slate-600">Log</button>
                        </div>
                        <div class="flex gap-1.5 overflow-x-auto no-scrollbar">
                            <button onclick="sortAttendance('status')" id="sort-status-btn"
                                class="px-3 py-1.5 bg-[#00A97A] text-white text-[8px] font-black uppercase tracking-widest rounded-lg shadow-md shadow-[#00A97A]/20 transition-soft">By
                                Status</button>
                            <button onclick="sortAttendance('name')" id="sort-name-btn"
                                class="px-3 py-1.5 bg-white border border-slate-100 text-slate-400 text-[8px] font-black uppercase tracking-widest rounded-lg transition-soft">By
                                Name</button>
                        </div>
                    </div>

                    <div id="attendance-status-container">
                        <div id="attendance-list" class="max-h-80 overflow-y-auto space-y-3 pr-2 custom-scrollbar">
                            <p class="text-slate-400 text-center py-10 text-[10px] font-bold uppercase tracking-widest">
                                Loading status...</p>
                        </div>
                    </div>
                </div>

                <div id="checkin-log-container" class="hidden space-y-3">
                    <div id="checkin-log" class="max-h-60 overflow-y-auto space-y-2 pr-2 custom-scrollbar text-[10px]">
                        <p class="text-slate-400 text-center py-10 font-bold uppercase tracking-widest">Loading
                            log...</p>
                    </div>
                </div>

                <div id="admin-actions-toolbar" class="flex gap-2 mt-6">
                    <button onclick="exportFullReport()"
                        class="flex-1 py-3 text-[9px] font-black text-slate-500 bg-white rounded-xl border border-slate-100 shadow-sm hover:border-[#00A97A] hover:text-[#00A97A] transition-soft uppercase tracking-widest">
                        <i data-lucide="download" class="w-3 h-3 inline-block mr-1 mb-0.5"></i> Export
                    </button>
                    <button onclick="clearCheckins()"
                        class="flex-1 py-3 text-[9px] font-black text-rose-400 bg-white rounded-xl border border-slate-100 shadow-sm hover:bg-rose-50 hover:border-rose-200 hover:text-rose-500 transition-soft uppercase tracking-widest">
                        <i data-lucide="trash-2" class="w-3 h-3 inline-block mr-1 mb-0.5"></i> Clear
                    </button>
                </div>

                <div class="space-y-4 pt-6">
                    <div class="bg-slate-50 border border-slate-100 rounded-2xl p-6 text-center hover:bg-slate-100/50 cursor-pointer transition-soft group"
                        id="drop-zone">
                        <div class="flex items-center justify-center gap-3">
                            <i data-lucide="upload-cloud" class="w-4 h-4 text-slate-400 group-hover:text-[#00A97A]"></i>
                            <p class="text-[9px] text-slate-500 font-black uppercase tracking-[0.2em]">Update
                                Participant
                                Database (CSV)</p>
                        </div>
                        <input type="file" id="csv-upload" accept=".csv" class="hidden"
                            aria-label="Upload Participant CSV">
                    </div>
                    <div id="upload-msg"
                        class="text-center text-[10px] font-black uppercase tracking-widest h-4 text-[#00A97A]"></div>

                    <button onclick="showView('input-view')"
                        class="w-full py-5 bg-slate-900 text-white rounded-2xl font-black text-[10px] tracking-[0.3em] uppercase shadow-2xl hover:-translate-y-1 transition-soft">EXIT
                        CONSOLE</button>
                </div>
            </div>

            <!-- Input View: Premium & Sleek -->
            <div id="input-view" class="hidden slide-in flex flex-col flex-1">
                <div class="space-y-10">
                    <div class="space-y-6">
                        <div class="space-y-2">
                            <label
                                class="block text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Full
                                Name</label>
                            <div class="relative group">
                                <div
                                    class="absolute inset-y-0 left-0 pl-5 flex items-center pointer-events-none transition-soft group-focus-within:text-[#00A97A]">
                                    <i data-lucide="user" class="w-5 h-5 text-slate-300"></i>
                                </div>
                                <input type="text" id="name-input" placeholder="Enter your name"
                                    class="w-full pl-12 pr-5 py-4 bg-slate-50 border border-slate-100/50 rounded-2xl focus:ring-4 focus:ring-[#00A97A]/10 focus:border-[#00A97A] outline-none transition-soft placeholder:text-slate-300 font-semibold text-slate-800">
                            </div>
                        </div>
                        <div class="space-y-2">
                            <label
                                class="block text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Mobile
                                Number</label>
                            <div class="relative group">
                                <div
                                    class="absolute inset-y-0 left-0 pl-5 flex items-center pointer-events-none transition-soft group-focus-within:text-[#00A97A]">
                                    <i data-lucide="phone" class="w-5 h-5 text-slate-300"></i>
                                </div>
                                <input type="tel" id="phone-input" placeholder="010-0000-0000"
                                    class="w-full pl-12 pr-5 py-4 bg-slate-50 border border-slate-100/50 rounded-2xl focus:ring-4 focus:ring-[#00A97A]/10 focus:border-[#00A97A] outline-none transition-soft placeholder:text-slate-300 font-semibold text-slate-800">
                            </div>
                        </div>

                        <button onclick="handleLookup()" id="verify-btn"
                            class="w-full bg-[#00A97A] text-white py-5 rounded-2xl font-black text-sm shadow-xl shadow-[#00A97A]/20 hover:shadow-[#00A97A]/40 hover:-translate-y-0.5 active:translate-y-0 transition-soft flex items-center justify-center gap-3 uppercase tracking-[0.25em] mt-4">
                            <span>확인</span>
                            <i data-lucide="chevron-right" class="w-5 h-5"></i>
                        </button>
                    </div>

                    <!-- Footer Corporate Accents -->
                </div>
            </div>

            <!-- Result View: High-End Personal Itinerary -->
            <div id="result-view" class="hidden slide-in space-y-0 flex-1">
                <!-- User Profile Header -->
                <div class="text-center pb-10 mb-8 border-b border-slate-100 relative">
                    <div class="space-y-2">
                        <h3 class="text-3xl font-heading font-black text-slate-900 tracking-tight leading-tight"><span
                                id="res-name" class="text-[#00A97A]">User</span>님</h3>
                        <div
                            class="inline-flex items-center gap-2 px-3 py-1 bg-slate-50 rounded-full border border-slate-100">
                            <div class="w-1.5 h-1.5 rounded-full bg-[#00A97A] animate-pulse"></div>
                            <p id="res-dept" class="text-[10px] text-slate-500 font-black uppercase tracking-widest">
                            </p>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-center">
                        <div class="bg-[#9E2AB5]/5 px-4 py-3 rounded-2xl border border-[#9E2AB5]/10 max-w-[240px]">
                            <p class="text-[10px] text-[#9E2AB5] font-black leading-relaxed tracking-wide">
                                <i data-lucide="info" class="w-3 h-3 inline-block mr-1 mb-0.5"></i>
                                현재 고객님을 위한 <br> 맞춤형 투어 정보가 준비되었습니다.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Course Highlight Card -->
                <div class="mb-8 group">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 ml-1">Your Activity
                    </p>
                    <div
                        class="bg-gradient-to-tr from-slate-900 to-slate-800 rounded-3xl p-6 shadow-2xl relative overflow-hidden transition-soft group-hover:scale-[1.01]">
                        <div class="absolute -right-4 -bottom-4 w-24 h-24 bg-white/5 rounded-full blur-2xl"></div>
                        <div class="z-10 relative">
                            <span
                                class="text-white/40 text-[9px] font-black uppercase tracking-widest block mb-2">Selected
                                Course</span>
                            <h4 id="res-activity-detail"
                                class="text-xl font-heading font-bold text-white tracking-tight leading-snug">A코스 :
                                한라산챌린지 (영실코스)</h4>
                        </div>
                    </div>
                </div>

                <!-- Logistics & Details: Modern Grid -->
                <div class="space-y-10">
                    <div class="grid grid-cols-2 gap-4">
                        <div
                            class="bg-white border border-slate-100 rounded-[2rem] p-5 shadow-premium group hover:border-[#00A97A]/30 transition-soft">
                            <div
                                class="w-10 h-10 bg-slate-50 rounded-2xl flex items-center justify-center mb-4 group-hover:bg-[#00A97A]/5 transition-soft">
                                <i data-lucide="clock"
                                    class="w-5 h-5 text-slate-400 group-hover:text-[#00A97A] transition-soft"></i>
                            </div>
                            <span
                                class="block text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Departure</span>
                            <span id="res-time" class="text-sm font-black text-slate-900">09:00</span>
                        </div>
                        <div
                            class="bg-white border border-slate-100 rounded-[2rem] p-5 shadow-premium group hover:border-[#00A97A]/30 transition-soft">
                            <div
                                class="w-10 h-10 bg-slate-50 rounded-2xl flex items-center justify-center mb-4 group-hover:bg-[#00A97A]/5 transition-soft">
                                <i data-lucide="map-pin"
                                    class="w-5 h-5 text-slate-400 group-hover:text-[#00A97A] transition-soft"></i>
                            </div>
                            <span
                                class="block text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Meeting
                                Point</span>
                            <span id="res-location" class="text-xs font-bold text-slate-900 truncate block">1층 로비</span>
                        </div>
                    </div>

                    <div
                        class="flex items-center gap-5 bg-slate-900 rounded-[2rem] p-5 shadow-2xl relative overflow-hidden group">
                        <div
                            class="absolute inset-0 bg-gradient-to-r from-[#00A97A]/10 to-transparent opacity-0 group-hover:opacity-100 transition-soft">
                        </div>
                        <div
                            class="w-12 h-12 bg-white/10 backdrop-blur-md rounded-2xl flex items-center justify-center border border-white/10">
                            <i data-lucide="user-check" class="w-6 h-6 text-[#00A97A]"></i>
                        </div>
                        <div class="flex-1">
                            <span
                                class="block text-[9px] font-black text-white/40 uppercase tracking-[0.2em] mb-0.5">Assigned
                                Guide</span>
                            <span id="res-guide" class="text-sm font-bold text-white">-</span>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-2 h-5 bg-[#00A97A] rounded-full"></div>
                                <h4 class="text-xs font-heading font-black text-slate-900 uppercase tracking-widest">
                                    Schedule Summary</h4>
                            </div>
                            <div class="px-3 py-1 bg-[#00A97A]/5 rounded-full border border-[#00A97A]/10">
                                <span
                                    class="text-[8px] font-black text-[#00A97A] uppercase tracking-widest">Real-time</span>
                            </div>
                        </div>
                        <div id="timeline-container" class="space-y-0 relative">
                            <!-- Items inserted via JS -->
                        </div>
                    </div>

                    <div id="notice-box" class="hidden pt-6">
                        <div
                            class="bg-amber-50/50 backdrop-blur-sm rounded-[2.5rem] p-7 border border-amber-100/50 relative overflow-hidden">
                            <div class="absolute -right-10 -top-10 w-32 h-32 bg-amber-100/20 rounded-full blur-3xl">
                            </div>
                            <div class="flex items-center gap-3 mb-5 text-amber-700">
                                <div class="w-8 h-8 bg-amber-100 rounded-xl flex items-center justify-center">
                                    <i data-lucide="alert-circle" class="w-4 h-4"></i>
                                </div>
                                <span class="text-[10px] font-black uppercase tracking-[0.2em]">Required
                                    Information</span>
                            </div>
                            <div class="space-y-4">
                                <div id="notice-supplies" class="flex items-start gap-3">
                                    <div class="mt-1.5 w-1 h-1 bg-amber-400 rounded-full flex-none"></div>
                                    <p class="text-xs text-amber-900/70 font-semibold leading-relaxed"><span></span></p>
                                </div>
                                <div id="notice-warning" class="flex items-start gap-3">
                                    <div class="mt-1.5 w-1 h-1 bg-amber-400 rounded-full flex-none"></div>
                                    <p class="text-xs text-amber-900/70 font-semibold leading-relaxed"><span></span></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="pt-8 pb-4 text-center">
                        <button onclick="resetApp()"
                            class="group inline-flex items-center gap-3 px-8 py-4 bg-slate-900 text-white rounded-2xl font-black text-[10px] uppercase tracking-[0.3em] shadow-xl hover:-translate-y-1 transition-soft active:translate-y-0">
                            <i data-lucide="arrow-left"
                                class="w-4 h-4 group-hover:-translate-x-1 transition-transform"></i>
                            <span>New Search</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Error View: Premium Feedback -->
            <div id="error-view"
                class="hidden slide-in flex flex-col items-center justify-center py-16 px-4 text-center space-y-8">
                <div class="relative">
                    <div class="w-20 h-20 bg-rose-50 rounded-[2rem] flex items-center justify-center mx-auto shadow-sm">
                        <i data-lucide="alert-triangle" class="w-10 h-10 text-rose-400"></i>
                    </div>
                    <div
                        class="absolute -right-2 -bottom-2 w-8 h-8 bg-white rounded-xl shadow-lg flex items-center justify-center border border-rose-50">
                        <i data-lucide="help-circle" class="w-4 h-4 text-rose-300"></i>
                    </div>
                </div>
                <div class="space-y-2">
                    <h2 class="text-2xl font-heading font-black text-slate-900 tracking-tight uppercase">정보를 찾을 수 없습니다
                    </h2>
                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Please Check Your Name &
                        Phone Number</p>
                </div>
                <button onclick="showView('input-view')"
                    class="w-full max-w-[240px] bg-slate-900 text-white font-black py-4 rounded-2xl text-[10px] tracking-[0.2em] uppercase shadow-2xl hover:-translate-y-1 transition-soft">다시
                    시도하기</button>
            </div>
        </div>

        <!-- App Footer -->
        <!-- App Footer Info -->
        <!-- App Footer Info -->
        <div class="py-12 px-10 text-center mt-auto">
            <div class="flex flex-col items-center gap-4">
                <div
                    class="flex items-center justify-center gap-3 opacity-20 grayscale transition-soft hover:opacity-50 hover:grayscale-0">
                    <img src="https://www.bbraun.co.kr/etc/designs/bbraun/img/logo.png" class="h-4 brightness-0"
                        alt="B. Braun">
                    <div class="w-px h-3 bg-slate-300"></div>
                    <span class="text-[9px] font-black text-slate-900 uppercase tracking-[0.4em]">Activity Portal</span>
                </div>
                <p class="text-[8px] text-slate-300 font-bold uppercase tracking-widest">© 2024 B. Braun Management
                    Korea</p>
            </div>
        </div>
    </div>

    <!-- Password Modal: Premium Overlay -->
    <div id="password-modal"
        class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center z-50 p-6">
        <div
            class="bg-white rounded-[2.5rem] p-10 w-full max-w-sm shadow-2xl border border-white/20 transform transition-soft">
            <div class="w-16 h-16 bg-[#00A97A]/5 rounded-2xl flex items-center justify-center mb-6 mx-auto">
                <i data-lucide="lock" class="w-8 h-8 text-[#00A97A]"></i>
            </div>
            <div class="text-center mb-8">
                <h3 class="text-xl font-heading font-black text-slate-900 tracking-tight uppercase">Admin Access</h3>
                <p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest mt-1">Management Console
                    Authentication</p>
            </div>

            <div class="space-y-4">
                <input type="password" id="password-input" placeholder="ACCESS KEY"
                    class="w-full px-6 py-5 bg-slate-50 border border-slate-200 rounded-2xl text-center font-black text-xs tracking-[0.3em] outline-none focus:border-[#00A97A] focus:bg-white transition-soft placeholder:text-slate-300">
                <p id="password-error"
                    class="hidden text-rose-500 text-[10px] font-black text-center uppercase tracking-widest">Validation
                    Failed. Retry.</p>

                <div class="flex gap-3 pt-4">
                    <button onclick="cancelPassword()"
                        class="flex-1 py-4 bg-slate-100 text-slate-400 rounded-2xl font-black text-[10px] uppercase tracking-widest hover:bg-slate-200 transition-soft">Close</button>
                    <button onclick="submitPassword()"
                        class="flex-1 py-4 bg-[#00A97A] text-white rounded-2xl font-black text-[10px] uppercase tracking-widest shadow-lg shadow-[#00A97A]/20 hover:-translate-y-1 transition-soft">Authorize</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // PHONE SANITIZATION
        // ============================================
        function sanitizePhoneNumber(input) {
            if (!input) return '';
            const trimmed = input.trim();
            const hasPlus = trimmed.startsWith('+');
            let digits = input.replace(/\D/g, '');

            // Handle +82 Korean country code (e.g., +82 10-1234-5678 → 1012345678)
            if (hasPlus && digits.startsWith('82')) {
                digits = digits.substring(2);  // Remove 82 prefix
                // If it starts with 10, keep it as is (already correct format)
                if (digits.startsWith('10')) {
                    return digits;  // 1012345678
                }
                // If it starts with 010, strip the leading 0
                if (digits.startsWith('010')) {
                    return digits.substring(1);  // 1012345678
                }
                return digits;
            }

            // Handle other international numbers (keep + prefix)
            if (hasPlus) {
                return '+' + digits;  // +97699990815
            }

            // Handle Korean 010 prefix
            if (digits.startsWith('010')) {
                return digits.substring(1);  // 1012345678
            }

            return digits;
        }

        // ============================================
        // ADMIN PASSWORD HANDLING
        // ============================================
        const ADMIN_PASSWORD = 'admin123';

        function toggleAdmin() {
            const adminView = document.getElementById('admin-view');

            // If already in admin mode, just exit
            if (adminView && !adminView.classList.contains('hidden')) {
                window.showView ? window.showView('input-view') : location.reload();
                return;
            }

            // Show password modal
            document.getElementById('password-modal').classList.remove('hidden');
            document.getElementById('password-input').value = '';
            document.getElementById('password-input').focus();
        }

        function submitPassword() {
            const password = document.getElementById('password-input').value;
            const errorEl = document.getElementById('password-error');
            const inputEl = document.getElementById('password-input');

            if (password !== ADMIN_PASSWORD) {
                errorEl.classList.remove('hidden');
                inputEl.classList.add('border-rose-500', 'bg-rose-50/30');
                inputEl.value = '';
                inputEl.focus();
                return;
            }

            // Hide modal and error
            document.getElementById('password-modal').classList.add('hidden');
            errorEl.classList.add('hidden');
            inputEl.classList.remove('border-rose-500', 'bg-rose-50/30');

            // Show admin view
            if (window.showView) {
                window.showView('admin-view');
            } else {
                document.querySelectorAll('#loading-view, #input-view, #result-view, #error-view').forEach(el => el.classList.add('hidden'));
                document.getElementById('admin-view').classList.remove('hidden');
            }
        }

        function cancelPassword() {
            document.getElementById('password-modal').classList.add('hidden');
        }

        // Allow Enter key to submit password
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('password-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') submitPassword();
            });
        });
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDocs, writeBatch, addDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = typeof __firebase_config !== 'undefined'
            ? JSON.parse(__firebase_config)
            : {
                apiKey: "AIzaSyAnp90bFTz6_E7r0tBPAYKu58GbwQqto0I",
                authDomain: "buslookup-5fd0d.firebaseapp.com",
                projectId: "buslookup-5fd0d",
                storageBucket: "buslookup-5fd0d.firebasestorage.app",
                messagingSenderId: "981605729788",
                appId: "1:981605729788:web:942a2188f3985433659e79",
                measurementId: "G-SXL79P93YD"
            };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let PARTICIPANTS = [];
        let currentUser = null;
        let dataLoadRetries = 0;
        const MAX_RETRIES = 3;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                dataLoadRetries = 0;
                await loadGlobalDataWithRetry();
            } else {
                try {
                    await signInAnonymously(auth);
                } catch (authError) {
                    console.error('Anonymous auth failed:', authError);
                    showConnectionError('인증에 실패했습니다. 페이지를 새로고침 해주세요.');
                }
            }
        });

        async function loadGlobalDataWithRetry() {
            while (dataLoadRetries < MAX_RETRIES) {
                try {
                    await loadGlobalData();
                    if (PARTICIPANTS.length > 0) {
                        showView('input-view');
                        return; // Success!
                    }
                } catch (error) {
                    console.error(`Data load attempt ${dataLoadRetries + 1} failed:`, error);
                }
                dataLoadRetries++;
                if (dataLoadRetries < MAX_RETRIES) {
                    await new Promise(r => setTimeout(r, 1000 * dataLoadRetries)); // Exponential backoff
                }
            }
            // All retries failed
            console.error('All data load attempts failed');
            showConnectionError('데이터를 불러올 수 없습니다. 네트워크를 확인하고 페이지를 새로고침 해주세요.');
        }

        async function loadGlobalData() {
            if (!currentUser) throw new Error('No authenticated user');

            // Force token refresh to prevent stale token issues
            try {
                await currentUser.getIdToken(true);
            } catch (tokenError) {
                console.warn('Token refresh failed, attempting re-auth...');
                await signInAnonymously(auth);
                return; // onAuthStateChanged will re-trigger loadGlobalData
            }

            const dataCol = collection(db, 'artifacts', appId, 'public', 'data', 'participants');
            const snapshot = await getDocs(dataCol);
            PARTICIPANTS = snapshot.docs.map(d => d.data());
            console.log(`Loaded ${PARTICIPANTS.length} participants`);
        }

        function showConnectionError(message) {
            const errorView = document.getElementById('error-view');
            const title = errorView.querySelector('h2');
            const desc = errorView.querySelector('p');
            if (title) title.textContent = '연결 오류';
            if (desc) desc.textContent = message;
            showView('error-view');
        }

        window.showView = (id) => {
            ['loading-view', 'admin-view', 'input-view', 'result-view', 'error-view'].forEach(v => document.getElementById(v).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');

            // Toggle Admin Icon State
            const adminIcon = document.getElementById('admin-icon');
            const adminTrigger = document.getElementById('admin-trigger');
            if (id === 'admin-view') {
                adminIcon.setAttribute('data-lucide', 'x');
                adminTrigger.classList.add('bg-slate-900', 'border-slate-900');
            } else {
                adminIcon.setAttribute('data-lucide', 'settings');
                adminTrigger.classList.remove('bg-slate-900', 'border-slate-900');
            }

            lucide.createIcons();
            if (id === 'admin-view') loadCheckins();
        };

        // ============================================
        // PHONE-CENTRIC LOOKUP (Ease of Use)
        // ============================================
        window.handleLookup = async () => {
            const nameInput = document.getElementById('name-input').value.trim();
            const phoneInput = document.getElementById('phone-input').value;
            const sanitizedPhone = sanitizePhoneNumber(phoneInput);

            if (!phoneInput) {
                alert("연락처를 입력해주세요.");
                return;
            }

            // Find by Phone Number only (addressing user feedback for typing convenience)
            const user = PARTICIPANTS.find(u => {
                const storedPhone = sanitizePhoneNumber(u.phone || u.휴대전화 || '');
                return storedPhone === sanitizedPhone;
            });

            if (user) {
                // Display user info
                const activityName = user.activity_name || user.액티비티 || user.bus || 'Activity';
                const displayName = user.name || user.이름 || nameInput;
                document.getElementById('res-name').textContent = displayName;
                document.getElementById('res-dept').textContent = user.department || user.부서 || '';

                // Format Activity Detail: "A코스 : 한라산챌린지 (영실코스)"
                document.getElementById('res-activity-detail').textContent = activityName;

                document.getElementById('res-time').textContent = user.start_time || user.출발시간 || user.time || '-';
                document.getElementById('res-location').textContent = user.meeting_point || user.집합장소 || '-';
                document.getElementById('res-guide').textContent = user.guide_info || user['가이드 정보'] || '-';

                // Build timeline
                const timelineContainer = document.getElementById('timeline-container');
                const schedules = [
                    user.schedule_1 || user['일정 1'],
                    user.schedule_2 || user['일정 2'],
                    user.schedule_3 || user['일정 3']
                ].filter(s => s && s.trim());

                if (schedules.length > 0) {
                    timelineContainer.innerHTML = schedules.map((s, idx) => `
                        <div class="flex gap-4 items-start relative group">
                            <div class="flex flex-col items-center flex-none">
                                <div class="w-2.5 h-2.5 rounded-full ${idx === 0 ? 'bg-[#00A97A]' : 'bg-slate-200'} z-10 shadow-sm border-2 border-white transition-soft group-hover:scale-125"></div>
                                ${idx !== schedules.length - 1 ? '<div class="w-px h-12 bg-slate-100 -mt-0.5"></div>' : ''}
                            </div>
                            <div class="pb-8">
                                <p class="text-[11px] font-bold text-slate-800 leading-relaxed transition-soft group-hover:text-slate-900">${s}</p>
                            </div>
                        </div>
                    `).join('');
                    // Refresh icons
                    if (window.lucide) lucide.createIcons();
                } else {
                    timelineContainer.innerHTML = '<p class="text-slate-400 text-xs">No schedule available</p>';
                }

                // Handle notice box
                const supplies = user.supplies || user.준비물 || '';
                const notice = user.notice || user.주의사항 || '';
                const noticeBox = document.getElementById('notice-box');

                if (supplies || notice) {
                    noticeBox.classList.remove('hidden');
                    noticeBox.querySelector('#notice-supplies span').textContent = supplies || '-';
                    noticeBox.querySelector('#notice-warning span').textContent = notice || '-';
                    noticeBox.querySelector('#notice-supplies').style.display = supplies ? 'flex' : 'none';
                    noticeBox.querySelector('#notice-warning').style.display = notice ? 'flex' : 'none';
                } else {
                    noticeBox.classList.add('hidden');
                }

                showView('result-view');

                // Log check-in to Firebase (with deduplication)
                try {
                    const checkinsRef = collection(db, 'artifacts', appId, 'public', 'data', 'checkins');

                    // Check if this phone number already has a check-in
                    const existingSnapshot = await getDocs(checkinsRef);
                    const alreadyCheckedIn = existingSnapshot.docs.some(doc => {
                        const data = doc.data();
                        return sanitizePhoneNumber(data.phone || '') === sanitizedPhone;
                    });

                    // Only create a new check-in if one doesn't exist
                    if (!alreadyCheckedIn) {
                        await addDoc(checkinsRef, {
                            name: user.name || user.이름 || nameInput,
                            phone: sanitizedPhone,
                            activity: user.activity_name || user.액티비티 || user.bus,
                            department: user.department || user.부서 || '',
                            checkedInAt: new Date().toISOString()
                        });
                        console.log('New check-in recorded for:', sanitizedPhone);
                    } else {
                        console.log('Already checked in:', sanitizedPhone);
                    }
                } catch (error) {
                    console.log('Check-in logging failed:', error);
                }
            } else {
                showView('error-view');
            }
        };

        window.resetApp = () => {
            document.getElementById('name-input').value = '';
            document.getElementById('phone-input').value = '';
            showView('input-view');
        };

        window.switchAdminTab = (tab) => {
            const logBtn = document.getElementById('tab-log-btn');
            const statusBtn = document.getElementById('tab-status-btn');
            const logCont = document.getElementById('checkin-log-container');
            const statusCont = document.getElementById('attendance-status-container');

            if (tab === 'log') {
                logBtn.className = "px-3 py-1.5 text-[9px] font-black uppercase tracking-widest rounded-lg transition-soft bg-white text-[#00A97A] shadow-sm";
                statusBtn.className = "px-3 py-1.5 text-[9px] font-black uppercase tracking-widest rounded-lg transition-soft text-slate-400 hover:text-slate-600";
                logCont.classList.remove('hidden');
                statusCont.classList.add('hidden');
            } else {
                statusBtn.className = "px-3 py-1.5 text-[9px] font-black uppercase tracking-widest rounded-lg transition-soft bg-white text-[#00A97A] shadow-sm";
                logBtn.className = "px-3 py-1.5 text-[9px] font-black uppercase tracking-widest rounded-lg transition-soft text-slate-400 hover:text-slate-600";
                statusCont.classList.remove('hidden');
                logCont.classList.add('hidden');
                renderAttendanceList();
            }
        };

        let currentCheckins = [];
        let currentSortMode = 'status'; // 'name', 'course', 'status'

        // Load check-ins and update dashboard
        async function loadCheckins() {
            try {
                const checkinsRef = collection(db, 'artifacts', appId, 'public', 'data', 'checkins');
                const q = query(checkinsRef, orderBy('checkedInAt', 'desc'));
                const snapshot = await getDocs(q);
                currentCheckins = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));

                const logEl = document.getElementById('checkin-log');
                document.getElementById('admin-total-count').textContent = PARTICIPANTS.length;
                document.getElementById('admin-checked-count').textContent = currentCheckins.length;

                if (currentCheckins.length === 0) {
                    logEl.innerHTML = '<p class="text-slate-400 text-center py-10 text-[10px] font-black uppercase tracking-widest">No Activity Logged</p>';
                } else {
                    logEl.innerHTML = currentCheckins.map(c => {
                        const time = new Date(c.checkedInAt).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
                        return `<div class="flex justify-between items-center bg-white border border-slate-100 rounded-xl px-4 py-2.5 transition-soft">
                            <div class="flex items-center gap-3">
                                <span class="font-black text-slate-900 text-[11px]">${c.name}</span>
                                <span class="text-[8px] text-slate-300 font-bold uppercase tracking-widest">${c.department || '-'}</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="text-[#9E2AB5] font-black text-[9px] uppercase tracking-tight">${(c.activity || '').split(':')[0]}</span>
                                <span class="text-[8px] font-bold text-slate-300">${time}</span>
                            </div>
                        </div>`;
                    }).join('');
                }
                if (window.lucide) lucide.createIcons();

                // If status tab is active, refresh it too
                if (!document.getElementById('attendance-status-container').classList.contains('hidden')) {
                    renderAttendanceList();
                }
            } catch (error) {
                console.error('Failed to load check-ins:', error);
            }
        }

        // Render the full list with check-in status
        window.sortAttendance = (mode) => {
            currentSortMode = mode;
            // Update UI Toolbar
            ['status', 'name'].forEach(m => {
                const btn = document.getElementById(`sort-${m}-btn`);
                if (m === mode) {
                    btn.className = "px-3 py-1.5 bg-[#00A97A] text-white text-[8px] font-black uppercase tracking-widest rounded-lg shadow-md shadow-[#00A97A]/20 transition-soft";
                } else {
                    btn.className = "px-3 py-1.5 bg-white border border-slate-100 text-slate-400 text-[8px] font-black uppercase tracking-widest rounded-lg transition-soft";
                }
            });
            renderAttendanceList();
        };

        function renderAttendanceList() {
            const listEl = document.getElementById('attendance-list');

            // Map checkins by sanitized phone for quick lookup
            const checkedMap = new Map();
            currentCheckins.forEach(c => {
                const sPhone = sanitizePhoneNumber(c.phone || '');
                if (sPhone) checkedMap.set(sPhone, c);
            });

            if (PARTICIPANTS.length === 0) {
                listEl.innerHTML = '<p class="text-slate-400 text-center py-8">Upload CSV first</p>';
                return;
            }

            // Create data for sorting
            const displayData = PARTICIPANTS.map(p => {
                const sPhone = sanitizePhoneNumber(p.phone || p.휴대전화 || '');
                return {
                    ...p,
                    sPhone,
                    isChecked: checkedMap.has(sPhone)
                };
            });

            // Apply sorting
            displayData.sort((a, b) => {
                if (currentSortMode === 'course') {
                    const activityA = a.activity_name || a.액티비티 || '';
                    const activityB = b.activity_name || b.액티비티 || '';
                    return activityA.localeCompare(activityB, 'ko-KR');
                } else if (currentSortMode === 'status') {
                    if (a.isChecked === b.isChecked) {
                        return (a.name || a.이름 || '').localeCompare(b.name || b.이름 || '', 'ko-KR');
                    }
                    return a.isChecked ? 1 : -1; // Pending first (false < true)
                } else {
                    // Default: Name
                    return (a.name || a.이름 || '').localeCompare(b.name || b.이름 || '', 'ko-KR');
                }
            });

            listEl.innerHTML = displayData.map(p => {
                return `<div class="flex justify-between items-center bg-white border border-slate-100 rounded-xl px-4 py-2 group hover:border-[#00A97A]/30 transition-soft">
                    <div class="flex items-center gap-3">
                        <div class="w-1.5 h-1.5 rounded-full ${p.isChecked ? 'bg-[#00A97A]' : 'bg-slate-200'}"></div>
                        <span class="font-black text-slate-900 text-[11px]">${p.name || p.이름}</span>
                        <span class="text-[8px] text-slate-300 font-bold uppercase tracking-widest">${p.department || '-'}</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="text-[#9E2AB5] font-black text-[8px] uppercase tracking-widest bg-[#9E2AB5]/5 px-1.5 py-0.5 rounded-md">${(p.activity_name || p.액티비티 || '').split(':')[0]}</span>
                        <div class="w-12 text-center">
                            ${p.isChecked
                        ? `<span class="text-[8px] font-black text-[#00A97A] uppercase tracking-widest">Done</span>`
                        : `<span class="text-[8px] font-black text-slate-300 uppercase tracking-widest">Wait</span>`
                    }
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        // Clear all check-ins
        window.clearCheckins = async () => {
            if (!confirm('This will delete all check-in records. Continue?')) return;
            try {
                const checkinsRef = collection(db, 'artifacts', appId, 'public', 'data', 'checkins');
                const snapshot = await getDocs(checkinsRef);
                const batch = writeBatch(db);
                snapshot.docs.forEach(d => batch.delete(d.ref));
                await batch.commit();
                await loadCheckins();
            } catch (error) {
                console.error('Failed to clear records:', error);
            }
        };

        // Export Full Report (Attendance Status)
        window.exportFullReport = async () => {
            if (PARTICIPANTS.length === 0) {
                alert('No participant data loaded');
                return;
            }

            const checkedMap = new Map();
            currentCheckins.forEach(c => {
                const sPhone = sanitizePhoneNumber(c.phone || '');
                if (sPhone) checkedMap.set(sPhone, c);
            });

            const headers = ['Name', 'Phone', 'Department', 'Activity', 'Status', 'Check-in Time'];
            const rows = PARTICIPANTS.map(p => {
                const sPhone = sanitizePhoneNumber(p.phone || p.휴대전화 || '');
                const check = checkedMap.get(sPhone);
                return [
                    p.name || p.이름,
                    p.phone || p.휴대전화 || '',
                    p.department || p.부서 || '',
                    p.activity_name || p.액티비티 || p.bus || '',
                    check ? 'CHECKED-IN' : 'PENDING',
                    check ? new Date(check.checkedInAt).toLocaleString('ko-KR') : '-'
                ];
            });

            const csvContent = [headers, ...rows]
                .map(row => row.map(cell => `"${cell}"`).join(','))
                .join('\n');

            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `attendance_report_${new Date().toISOString().slice(0, 10)}.csv`;
            link.click();
            URL.revokeObjectURL(url);
        };

        // ============================================
        // CSV UPLOAD WITH SANITIZATION
        // ============================================
        document.getElementById('drop-zone').onclick = () => document.getElementById('csv-upload').click();
        document.getElementById('csv-upload').onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (event) => {
                const text = event.target.result;
                const lines = text.split('\n');
                const headers = lines[0].split(',').map(h => h.trim().replace(/^\uFEFF/, ''));

                const newData = [];
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;

                    const cols = line.split(',').map(c => c.trim());
                    if (cols.length < 4) continue;

                    // Map CSV columns to data object with sanitized phone
                    const participant = {
                        name: cols[headers.indexOf('이름')] || cols[0] || '',
                        department: cols[headers.indexOf('부서')] || cols[1] || '',
                        phone: sanitizePhoneNumber(cols[headers.indexOf('휴대전화')] || cols[2] || ''),
                        activity_name: cols[headers.indexOf('액티비티')] || cols[3] || '',
                        start_time: cols[headers.indexOf('출발시간')] || cols[4] || '',
                        meeting_point: cols[headers.indexOf('집합장소')] || cols[5] || '',
                        guide_info: cols[headers.indexOf('가이드 정보')] || cols[6] || '',
                        schedule_1: cols[headers.indexOf('일정 1')] || cols[7] || '',
                        schedule_2: cols[headers.indexOf('일정 2')] || cols[8] || '',
                        schedule_3: cols[headers.indexOf('일정 3')] || cols[9] || '',
                        supplies: cols[headers.indexOf('준비물')] || cols[10] || '',
                        notice: cols[headers.indexOf('주의사항')] || cols[11] || ''
                    };

                    newData.push(participant);
                }

                if (newData.length > 0) {
                    try {
                        // Delete existing participants first
                        const existingCol = collection(db, 'artifacts', appId, 'public', 'data', 'participants');
                        const existingSnapshot = await getDocs(existingCol);
                        const deleteBatch = writeBatch(db);
                        existingSnapshot.docs.forEach(d => deleteBatch.delete(d.ref));
                        await deleteBatch.commit();

                        // Add new participants
                        const addBatch = writeBatch(db);
                        newData.forEach((p, idx) => {
                            const ref = doc(db, 'artifacts', appId, 'public', 'data', 'participants', `p_${idx}`);
                            addBatch.set(ref, p);
                        });
                        await addBatch.commit();
                        await loadGlobalData();

                        document.getElementById('upload-msg').innerHTML = `
                            <div class="inline-flex items-center gap-2 px-4 py-2 bg-[#00A97A]/5 text-[#00A97A] rounded-full border border-[#00A97A]/10 animate-fade-in shadow-sm">
                                <i data-lucide="check-circle-2" class="w-3.5 h-3.5"></i>
                                <span class="text-[9px] font-black uppercase tracking-widest">${newData.length} Entries Synced Successfully</span>
                            </div>`;
                        lucide.createIcons();
                        setTimeout(() => {
                            document.getElementById('upload-msg').innerHTML = '';
                        }, 4000);
                    } catch (error) {
                        console.error('Upload error:', error);
                        document.getElementById('upload-msg').innerHTML = `
                            <div class="inline-flex items-center gap-2 px-4 py-2 bg-rose-50 text-rose-500 rounded-full border border-rose-100 animate-fade-in shadow-sm">
                                <i data-lucide="alert-circle" class="w-3.5 h-3.5"></i>
                                <span class="text-[9px] font-black uppercase tracking-widest">Protocol Sync Failed</span>
                            </div>`;
                        lucide.createIcons();
                    }
                }
            };
            reader.readAsText(file);
        };

        // Initialize icons
        lucide.createIcons();
    </script>
</body>

</html>
