<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activity Check-In Portal</title>
    <meta name="description" content="Corporate activity selection and itinerary lookup portal">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        .slide-in {
            animation: slideIn 0.4s ease-out forwards;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Timeline styling */
        .timeline-item {
            position: relative;
            padding-left: 2rem;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: 0.45rem;
            top: 1.5rem;
            width: 2px;
            height: calc(100% - 0.5rem);
            background: #e2e8f0;
        }

        .timeline-item:last-child::before {
            display: none;
        }

        .timeline-dot {
            position: absolute;
            left: 0;
            top: 0.25rem;
            width: 1rem;
            height: 1rem;
            border-radius: 50%;
            background: #00A97A;
            border: 3px solid white;
            box-shadow: 0 0 0 2px #00A97A;
        }
    </style>
</head>

<body class="bg-slate-100 min-h-screen flex items-center justify-center p-4">
    <div id="app" class="w-full max-w-md bg-white rounded-[2.5rem] shadow-2xl overflow-hidden border border-slate-200">
        <!-- Main Header: Clean White with Company Logo -->
        <div class="bg-[#00A97A] px-6 py-5 flex justify-between items-center relative text-white">
            <div class="flex items-center gap-3">
                <div
                    class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center border border-white/30 backdrop-blur-md">
                    <i data-lucide="building-2" class="w-6 h-6 text-white"></i>
                </div>
                <div class="flex flex-col">
                    <span class="text-[10px] font-bold text-white/60 tracking-[0.2em] leading-tight">B. BRAUN</span>
                    <span class="text-sm font-black text-white tracking-wide uppercase">COMPANY LOGO</span>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <div id="admin-trigger" onclick="toggleAdmin()"
                    class="cursor-pointer hover:bg-white/10 p-2 rounded-xl transition-colors">
                    <i data-lucide="settings" class="w-5 h-5 text-white/50"></i>
                </div>
            </div>
        </div>

        <!-- Key Visual Banner -->
        <div class="relative h-48 flex items-center justify-center overflow-hidden bg-white">
            <div class="absolute inset-0 bg-gradient-to-br from-[#00A97A]/5 via-white to-[#9E2AB5]/5"></div>
            <div class="absolute inset-0 bg-[radial-gradient(circle_at_50%_50%,rgba(0,169,122,0.05),transparent_70%)]">
            </div>
            <div class="z-10 text-center px-4">
                <div
                    class="w-20 h-20 mx-auto bg-slate-50 rounded-full flex items-center justify-center border border-slate-100 mb-4 shadow-sm">
                    <i data-lucide="image" class="w-8 h-8 text-slate-200"></i>
                </div>
                <p class="text-[11px] text-slate-300 font-black uppercase tracking-[0.3em] leading-relaxed">행사 키비주얼
                    이미지<br><span class="opacity-50">(EVENT KEY VISUAL)</span></p>
            </div>
            <!-- Decorative Dots -->
            <div class="absolute bottom-4 right-4 flex gap-1">
                <div class="w-1 h-1 rounded-full bg-[#00A97A]/20"></div>
                <div class="w-1 h-1 rounded-full bg-[#00A97A]/20"></div>
                <div class="w-1 h-1 rounded-full bg-[#00A97A]/20"></div>
            </div>
        </div>

        <div class="p-8 relative min-h-[400px] flex flex-col" id="content-area">
            <!-- Loading View -->
            <div id="loading-view" class="flex flex-col items-center justify-center py-20 space-y-4">
                <div class="w-12 h-12 border-4 border-[#00A97A] border-t-transparent rounded-full animate-spin"></div>
                <p class="text-slate-400 font-medium text-sm">Syncing with cloud...</p>
            </div>

            <!-- Admin View -->
            <div id="admin-view" class="hidden slide-in space-y-6">
                <div class="text-center">
                    <h2 class="text-xl font-bold text-slate-800">Admin Dashboard</h2>
                </div>

                <!-- Stats Grid -->
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100 flex flex-col items-center">
                        <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Total
                            Reg.</span>
                        <span id="admin-total-count" class="text-xl font-black text-slate-800">0</span>
                    </div>
                    <div
                        class="bg-[#00A97A]/5 p-4 rounded-2xl border border-[#00A97A]/10 flex flex-col items-center text-[#00A97A]">
                        <span class="text-[10px] font-black text-[#00A97A]/50 uppercase tracking-widest mb-1">Checked
                            In</span>
                        <span id="admin-checked-count" class="text-xl font-black">0</span>
                    </div>
                </div>

                <div class="border-2 border-dashed border-slate-200 rounded-2xl p-6 text-center bg-slate-50 hover:border-[#00A97A] cursor-pointer transition-colors"
                    id="drop-zone">
                    <i data-lucide="upload-cloud" class="w-8 h-8 mx-auto text-slate-400 mb-2"></i>
                    <p class="text-[10px] text-slate-500 font-bold uppercase tracking-wider">Update Participant CSV</p>
                    <input type="file" id="csv-upload" accept=".csv" class="hidden" aria-label="Upload Participant CSV">
                </div>
                <div id="upload-msg" class="text-center text-xs font-bold uppercase tracking-widest h-4"></div>

                <div class="border-t border-slate-100 pt-6">
                    <!-- Tabs -->
                    <div class="flex gap-4 mb-4 border-b border-slate-50">
                        <button onclick="switchAdminTab('status')" id="tab-status-btn"
                            class="pb-2 text-[10px] font-black uppercase tracking-widest text-[#00A97A] border-b-2 border-[#00A97A]">Attendance
                            Status</button>
                        <button onclick="switchAdminTab('log')" id="tab-log-btn"
                            class="pb-2 text-[10px] font-black uppercase tracking-widest text-slate-300">Check-in
                            Log</button>
                    </div>

                    <div id="attendance-status-container" class="space-y-4">
                        <div class="flex gap-2 px-1 overflow-x-auto pb-1 no-scrollbar">
                            <button onclick="sortAttendance('status')" id="sort-status-btn"
                                class="flex-none px-3 py-1.5 rounded-lg text-[9px] font-black uppercase tracking-wider transition-all border-2 border-[#00A97A] bg-[#00A97A] text-white">Status</button>
                            <button onclick="sortAttendance('name')" id="sort-name-btn"
                                class="flex-none px-3 py-1.5 rounded-lg text-[9px] font-black uppercase tracking-wider transition-all border-2 border-slate-100 bg-white text-slate-400">Name</button>
                            <button onclick="sortAttendance('course')" id="sort-course-btn"
                                class="flex-none px-3 py-1.5 rounded-lg text-[9px] font-black uppercase tracking-wider transition-all border-2 border-slate-100 bg-white text-slate-400">Course</button>
                        </div>

                        <div class="flex justify-between items-center px-2">
                            <span
                                class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Participant</span>
                            <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Status</span>
                        </div>
                        <div id="attendance-list" class="max-h-80 overflow-y-auto space-y-2 text-xs">
                            <p class="text-slate-400 text-center py-4">Loading status...</p>
                        </div>
                    </div>

                    <div id="checkin-log-container" class="hidden space-y-2">
                        <div id="checkin-log" class="max-h-60 overflow-y-auto space-y-2 text-xs">
                            <p class="text-slate-400 text-center py-4">Loading log...</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-2 mt-6">
                        <button onclick="exportFullReport()"
                            class="py-3 text-[10px] font-black text-[#00A97A] border border-[#00A97A]/20 bg-white rounded-xl shadow-sm hover:bg-[#00A97A]/5 transition-all uppercase tracking-widest">Full
                            Report</button>
                        <button onclick="clearCheckins()"
                            class="py-3 text-[10px] font-black text-rose-500 border border-rose-100 bg-white rounded-xl shadow-sm hover:bg-rose-50 transition-all uppercase tracking-widest">Clear
                            Logs</button>
                    </div>
                </div>

                <button onclick="showView('input-view')"
                    class="w-full py-4 bg-slate-800 text-white rounded-2xl font-black text-xs tracking-[0.2em] uppercase shadow-lg shadow-slate-200">EXIT
                    DASHBOARD</button>
            </div>

            <!-- Input View (Verification) -->
            <div id="input-view" class="hidden slide-in space-y-0 flex-1">
                <!-- Violet Title Banner -->
                <div
                    class="bg-[#9E2AB5] py-4 text-center mb-12 mx-[-2rem] relative shadow-[0_4px_12px_rgba(158,42,181,0.2)]">
                    <h2 class="text-white font-black text-sm tracking-[0.3em] uppercase">Day 2 선택 Activity</h2>
                    <div class="absolute bottom-0 left-0 right-0 h-1 bg-black/10"></div>
                </div>

                <div class="space-y-10">
                    <div class="relative group">
                        <label
                            class="absolute -top-3 left-4 px-2 bg-white text-[10px] font-black text-[#9E2AB5] tracking-widest uppercase transition-all group-focus-within:text-[#00A97A]">성명
                            (Name)</label>
                        <input type="text" id="name-input" placeholder="성명을 입력하세요"
                            class="w-full px-6 py-4 bg-white border-2 border-slate-100 rounded-2xl outline-none focus:border-[#009268] focus:ring-4 focus:ring-[#00A97A]/10 transition-all font-bold text-slate-800 placeholder:text-slate-300">
                    </div>

                    <div class="relative group">
                        <label
                            class="absolute -top-3 left-4 px-2 bg-white text-[10px] font-black text-[#9E2AB5] tracking-widest uppercase transition-all group-focus-within:text-[#00A97A]">연락처
                            (Phone)</label>
                        <input type="tel" id="phone-input" placeholder="연락처를 입력하세요"
                            class="w-full px-6 py-4 bg-white border-2 border-slate-100 rounded-2xl outline-none focus:border-[#009268] focus:ring-4 focus:ring-[#00A97A]/10 transition-all font-bold text-slate-800 placeholder:text-slate-300">
                    </div>

                    <button onclick="handleLookup()" id="find-btn"
                        class="w-full bg-[#00A97A] text-white font-black py-5 rounded-2xl shadow-[0_8px_20px_rgba(0,169,122,0.2)] hover:bg-[#009268] hover:translate-y-[-2px] active:scale-[0.98] transition-all mt-10 text-sm tracking-[0.2em] uppercase">
                        본인 인증 (Verify)
                    </button>

                    <p class="text-[10px] text-center text-slate-300 font-bold uppercase tracking-widest">Secure
                        Verification Portal</p>
                </div>
            </div>

            <!-- Result View (Personal Itinerary) -->
            <div id="result-view" class="hidden slide-in space-y-0 flex-1">
                <!-- User Profile Summary -->
                <div class="space-y-3 text-center pb-8 mb-8 border-b-2 border-slate-50 relative">
                    <div
                        class="w-20 h-20 bg-gradient-to-tr from-[#00A97A] to-[#00C896] rounded-full mx-auto flex items-center justify-center shadow-lg mb-4">
                        <span id="res-name-initial" class="text-2xl font-black text-white uppercase">U</span>
                    </div>
                    <div>
                        <h3 class="text-xl font-black text-slate-800 tracking-tight"><span id="res-name">User</span>님
                        </h3>
                        <p id="res-dept" class="text-xs text-slate-400 font-black uppercase tracking-widest mt-1"></p>
                    </div>
                    <div class="mt-4 px-6 py-2 bg-slate-50 rounded-full inline-block">
                        <p class="text-[11px] text-slate-600 font-bold">선택투어는 <span id="res-activity-summary"
                                class="text-[#9E2AB5] font-black">Activity</span> 입니다.</p>
                    </div>
                </div>

                <!-- Activity Banner -->
                <div
                    class="bg-[#9E2AB5] py-4 text-center mx-[-2rem] mb-10 shadow-[0_4px_12px_rgba(158,42,181,0.15)] relative">
                    <h2 class="text-white font-black text-xs tracking-[0.2em] uppercase"><span
                            id="res-activity-banner">Activity</span> 투어 안내</h2>
                </div>

                <!-- Logistics Card -->
                <div class="space-y-8">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100/50">
                            <span
                                class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Departure</span>
                            <span id="res-time" class="text-sm font-black text-slate-800">09:00</span>
                        </div>
                        <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100/50">
                            <span
                                class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Meeting
                                Point</span>
                            <span id="res-location" class="text-sm font-black text-slate-800 truncate">1층 로비</span>
                        </div>
                    </div>

                    <div class="flex items-center gap-4 bg-[#00A97A]/5 p-4 rounded-2xl border border-[#00A97A]/10">
                        <div class="w-10 h-10 bg-white rounded-xl flex items-center justify-center shadow-sm">
                            <i data-lucide="user" class="w-5 h-5 text-[#00A97A]"></i>
                        </div>
                        <div>
                            <span class="block text-[10px] font-black text-slate-400 uppercase tracking-widest">Guide
                                Info</span>
                            <span id="res-guide" class="text-sm font-bold text-slate-700">-</span>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <div class="flex items-center gap-2">
                            <div class="w-1.5 h-4 bg-[#9E2AB5] rounded-full"></div>
                            <h4 class="text-[11px] font-black text-slate-800 uppercase tracking-widest">Schedule Summary
                            </h4>
                        </div>
                        <div id="timeline-container" class="space-y-3 pl-1">
                            <!-- Items inserted via JS -->
                        </div>
                    </div>

                    <div id="notice-box" class="pt-8 border-t border-slate-100 space-y-4 hidden slide-in">
                        <div class="bg-amber-50 rounded-2xl p-5 border border-amber-100">
                            <div class="flex items-center gap-2 mb-3 text-amber-700">
                                <i data-lucide="alert-circle" class="w-4 h-4"></i>
                                <span class="text-[10px] font-black uppercase tracking-widest">Important Notice</span>
                            </div>
                            <div class="space-y-3">
                                <div id="notice-supplies" class="text-xs text-amber-900/70 font-bold leading-relaxed">
                                    <span class="text-amber-600 mr-2">●</span><span></span>
                                </div>
                                <div id="notice-warning" class="text-xs text-amber-900/70 font-bold leading-relaxed">
                                    <span class="text-amber-600 mr-2">●</span><span></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="pt-10 pb-4 text-center">
                        <button onclick="resetApp()"
                            class="group flex items-center justify-center gap-2 mx-auto text-slate-300 hover:text-[#00A97A] transition-all">
                            <i data-lucide="arrow-left"
                                class="w-4 h-4 group-hover:-translate-x-1 transition-transform"></i>
                            <span class="text-[10px] font-black uppercase tracking-[0.3em]">New Search</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Error View -->
            <div id="error-view" class="hidden slide-in text-center py-12 space-y-6">
                <div class="w-16 h-16 bg-rose-50 rounded-full flex items-center justify-center mx-auto">
                    <i data-lucide="info" class="w-8 h-8 text-rose-400"></i>
                </div>
                <h2 class="text-xl font-bold text-slate-800">정보를 찾을 수 없습니다</h2>
                <p class="text-sm text-slate-400">성명과 연락처를 다시 확인해 주세요.</p>
                <button onclick="showView('input-view')"
                    class="w-full bg-slate-800 text-white font-bold py-4 rounded-xl text-sm">다시 시도하기</button>
            </div>
        </div>

        <!-- App Footer -->
        <!-- App Footer Info -->
        <div class="bg-white border-t border-slate-50 py-8 px-10 text-center mt-auto">
            <div
                class="flex items-center justify-center gap-3 opacity-30 grayscale saturate-0 hover:grayscale-0 hover:saturate-100 transition-all cursor-default">
                <div class="w-6 h-6 rounded-lg bg-slate-800 flex items-center justify-center">
                    <i data-lucide="award" class="w-3.5 h-3.5 text-white"></i>
                </div>
                <span class="text-[10px] font-black text-slate-800 uppercase tracking-[0.5em]">행사 logo</span>
            </div>
        </div>
    </div>

    <!-- Password Modal -->
    <div id="password-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl p-6 w-full max-w-xs shadow-2xl">
            <h3 class="text-lg font-bold text-slate-800 mb-4">Admin Access</h3>
            <input type="password" id="password-input" placeholder="Enter password"
                class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl mb-2 outline-none focus:border-[#00A97A]">
            <p id="password-error" class="hidden text-rose-500 text-sm mb-2 font-medium">Incorrect password</p>
            <div class="flex gap-3">
                <button onclick="cancelPassword()"
                    class="flex-1 py-3 bg-slate-200 text-slate-700 rounded-xl font-bold">Cancel</button>
                <button onclick="submitPassword()"
                    class="flex-1 py-3 bg-[#00A97A] text-white rounded-xl font-bold">Enter</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // PHONE SANITIZATION
        // ============================================
        function sanitizePhoneNumber(input) {
            if (!input) return '';
            const trimmed = input.trim();
            const hasPlus = trimmed.startsWith('+');
            let digits = input.replace(/\D/g, '');

            // Handle +82 Korean country code (e.g., +82 10-1234-5678 → 1012345678)
            if (hasPlus && digits.startsWith('82')) {
                digits = digits.substring(2);  // Remove 82 prefix
                // If it starts with 10, keep it as is (already correct format)
                if (digits.startsWith('10')) {
                    return digits;  // 1012345678
                }
                // If it starts with 010, strip the leading 0
                if (digits.startsWith('010')) {
                    return digits.substring(1);  // 1012345678
                }
                return digits;
            }

            // Handle other international numbers (keep + prefix)
            if (hasPlus) {
                return '+' + digits;  // +97699990815
            }

            // Handle Korean 010 prefix
            if (digits.startsWith('010')) {
                return digits.substring(1);  // 1012345678
            }

            return digits;
        }

        // ============================================
        // ADMIN PASSWORD HANDLING
        // ============================================
        const ADMIN_PASSWORD = 'admin123';

        function toggleAdmin() {
            const adminView = document.getElementById('admin-view');

            // If already in admin mode, just exit
            if (adminView && !adminView.classList.contains('hidden')) {
                window.showView ? window.showView('input-view') : location.reload();
                return;
            }

            // Show password modal
            document.getElementById('password-modal').classList.remove('hidden');
            document.getElementById('password-input').value = '';
            document.getElementById('password-input').focus();
        }

        function submitPassword() {
            const password = document.getElementById('password-input').value;
            const errorEl = document.getElementById('password-error');

            if (password !== ADMIN_PASSWORD) {
                errorEl.classList.remove('hidden');
                const inputEl = document.getElementById('password-input');
                inputEl.classList.add('border-rose-500');
                inputEl.value = '';
                inputEl.focus();
                return;
            }

            // Hide modal and error
            document.getElementById('password-modal').classList.add('hidden');
            errorEl.classList.add('hidden');

            // Show admin view
            if (window.showView) {
                window.showView('admin-view');
            } else {
                document.querySelectorAll('#loading-view, #input-view, #result-view, #error-view').forEach(el => el.classList.add('hidden'));
                document.getElementById('admin-view').classList.remove('hidden');
            }
        }

        function cancelPassword() {
            document.getElementById('password-modal').classList.add('hidden');
        }

        // Allow Enter key to submit password
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('password-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') submitPassword();
            });
        });
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDocs, writeBatch, addDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = typeof __firebase_config !== 'undefined'
            ? JSON.parse(__firebase_config)
            : {
                apiKey: "AIzaSyAnp90bFTz6_E7r0tBPAYKu58GbwQqto0I",
                authDomain: "buslookup-5fd0d.firebaseapp.com",
                projectId: "buslookup-5fd0d",
                storageBucket: "buslookup-5fd0d.firebasestorage.app",
                messagingSenderId: "981605729788",
                appId: "1:981605729788:web:942a2188f3985433659e79",
                measurementId: "G-SXL79P93YD"
            };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let PARTICIPANTS = [];
        let currentUser = null;
        let dataLoadRetries = 0;
        const MAX_RETRIES = 3;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                dataLoadRetries = 0;
                await loadGlobalDataWithRetry();
            } else {
                try {
                    await signInAnonymously(auth);
                } catch (authError) {
                    console.error('Anonymous auth failed:', authError);
                    showConnectionError('인증에 실패했습니다. 페이지를 새로고침 해주세요.');
                }
            }
        });

        async function loadGlobalDataWithRetry() {
            while (dataLoadRetries < MAX_RETRIES) {
                try {
                    await loadGlobalData();
                    if (PARTICIPANTS.length > 0) {
                        showView('input-view');
                        return; // Success!
                    }
                } catch (error) {
                    console.error(`Data load attempt ${dataLoadRetries + 1} failed:`, error);
                }
                dataLoadRetries++;
                if (dataLoadRetries < MAX_RETRIES) {
                    await new Promise(r => setTimeout(r, 1000 * dataLoadRetries)); // Exponential backoff
                }
            }
            // All retries failed
            console.error('All data load attempts failed');
            showConnectionError('데이터를 불러올 수 없습니다. 네트워크를 확인하고 페이지를 새로고침 해주세요.');
        }

        async function loadGlobalData() {
            if (!currentUser) throw new Error('No authenticated user');

            // Force token refresh to prevent stale token issues
            try {
                await currentUser.getIdToken(true);
            } catch (tokenError) {
                console.warn('Token refresh failed, attempting re-auth...');
                await signInAnonymously(auth);
                return; // onAuthStateChanged will re-trigger loadGlobalData
            }

            const dataCol = collection(db, 'artifacts', appId, 'public', 'data', 'participants');
            const snapshot = await getDocs(dataCol);
            PARTICIPANTS = snapshot.docs.map(d => d.data());
            console.log(`Loaded ${PARTICIPANTS.length} participants`);
        }

        function showConnectionError(message) {
            const errorView = document.getElementById('error-view');
            const title = errorView.querySelector('h2');
            const desc = errorView.querySelector('p');
            if (title) title.textContent = '연결 오류';
            if (desc) desc.textContent = message;
            showView('error-view');
        }

        window.showView = (id) => {
            ['loading-view', 'admin-view', 'input-view', 'result-view', 'error-view'].forEach(v => document.getElementById(v).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            lucide.createIcons();
            if (id === 'admin-view') loadCheckins();
        };

        // ============================================
        // PHONE-CENTRIC LOOKUP (Ease of Use)
        // ============================================
        window.handleLookup = async () => {
            const nameInput = document.getElementById('name-input').value.trim();
            const phoneInput = document.getElementById('phone-input').value;
            const sanitizedPhone = sanitizePhoneNumber(phoneInput);

            if (!phoneInput) {
                alert("연락처를 입력해주세요.");
                return;
            }

            // Find by Phone Number only (addressing user feedback for typing convenience)
            const user = PARTICIPANTS.find(u => {
                const storedPhone = sanitizePhoneNumber(u.phone || u.휴대전화 || '');
                return storedPhone === sanitizedPhone;
            });

            if (user) {
                // Display user info
                const activityName = user.activity_name || user.액티비티 || user.bus || 'Activity';
                const displayName = user.name || user.이름 || nameInput;
                document.getElementById('res-name').textContent = displayName;
                document.getElementById('res-name-initial').textContent = displayName.charAt(0);
                document.getElementById('res-dept').textContent = user.department || user.부서 || '';
                document.getElementById('res-activity-summary').textContent = activityName;
                document.getElementById('res-activity-banner').textContent = activityName;
                document.getElementById('res-time').textContent = user.start_time || user.출발시간 || user.time || '-';
                document.getElementById('res-location').textContent = user.meeting_point || user.집합장소 || '-';
                document.getElementById('res-guide').textContent = user.guide_info || user['가이드 정보'] || '-';

                // Build timeline
                const timelineContainer = document.getElementById('timeline-container');
                const schedules = [
                    user.schedule_1 || user['일정 1'],
                    user.schedule_2 || user['일정 2'],
                    user.schedule_3 || user['일정 3']
                ].filter(s => s && s.trim());

                if (schedules.length > 0) {
                    timelineContainer.innerHTML = schedules.map((s, idx) => `
                        <div class="flex gap-3 text-slate-700">
                            <span class="font-bold text-slate-300">${idx + 1}</span>
                            <p class="font-medium">${s}</p>
                        </div>
                    `).join('');
                } else {
                    timelineContainer.innerHTML = '<p class="text-slate-400 text-xs">No schedule available</p>';
                }

                // Handle notice box
                const supplies = user.supplies || user.준비물 || '';
                const notice = user.notice || user.주의사항 || '';
                const noticeBox = document.getElementById('notice-box');

                if (supplies || notice) {
                    noticeBox.classList.remove('hidden');
                    noticeBox.querySelector('#notice-supplies span').textContent = supplies || '-';
                    noticeBox.querySelector('#notice-warning span').textContent = notice || '-';
                    noticeBox.querySelector('#notice-supplies').style.display = supplies ? 'flex' : 'none';
                    noticeBox.querySelector('#notice-warning').style.display = notice ? 'flex' : 'none';
                } else {
                    noticeBox.classList.add('hidden');
                }

                showView('result-view');

                // Log check-in to Firebase (with deduplication)
                try {
                    const checkinsRef = collection(db, 'artifacts', appId, 'public', 'data', 'checkins');

                    // Check if this phone number already has a check-in
                    const existingSnapshot = await getDocs(checkinsRef);
                    const alreadyCheckedIn = existingSnapshot.docs.some(doc => {
                        const data = doc.data();
                        return sanitizePhoneNumber(data.phone || '') === sanitizedPhone;
                    });

                    // Only create a new check-in if one doesn't exist
                    if (!alreadyCheckedIn) {
                        await addDoc(checkinsRef, {
                            name: user.name || user.이름 || nameInput,
                            phone: sanitizedPhone,
                            activity: user.activity_name || user.액티비티 || user.bus,
                            department: user.department || user.부서 || '',
                            checkedInAt: new Date().toISOString()
                        });
                        console.log('New check-in recorded for:', sanitizedPhone);
                    } else {
                        console.log('Already checked in:', sanitizedPhone);
                    }
                } catch (error) {
                    console.log('Check-in logging failed:', error);
                }
            } else {
                showView('error-view');
            }
        };

        window.resetApp = () => {
            document.getElementById('name-input').value = '';
            document.getElementById('phone-input').value = '';
            showView('input-view');
        };

        // Admin UI Tab Control
        window.switchAdminTab = (tab) => {
            const logBtn = document.getElementById('tab-log-btn');
            const statusBtn = document.getElementById('tab-status-btn');
            const logCont = document.getElementById('checkin-log-container');
            const statusCont = document.getElementById('attendance-status-container');

            if (tab === 'log') {
                logBtn.classList.add('text-[#00A97A]', 'border-b-2', 'border-[#00A97A]');
                logBtn.classList.remove('text-slate-300');
                statusBtn.classList.remove('text-[#00A97A]', 'border-b-2', 'border-[#00A97A]');
                statusBtn.classList.add('text-slate-300');
                logCont.classList.remove('hidden');
                statusCont.classList.add('hidden');
            } else {
                statusBtn.classList.add('text-[#00A97A]', 'border-b-2', 'border-[#00A97A]');
                statusBtn.classList.remove('text-slate-300');
                logBtn.classList.remove('text-[#00A97A]', 'border-b-2', 'border-[#00A97A]');
                logBtn.classList.add('text-slate-300');
                statusCont.classList.remove('hidden');
                logCont.classList.add('hidden');
                renderAttendanceList();
            }
        };

        let currentCheckins = [];
        let currentSortMode = 'status'; // 'name', 'course', 'status'

        // Load check-ins and update dashboard
        async function loadCheckins() {
            try {
                const checkinsRef = collection(db, 'artifacts', appId, 'public', 'data', 'checkins');
                const q = query(checkinsRef, orderBy('checkedInAt', 'desc'));
                const snapshot = await getDocs(q);
                currentCheckins = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));

                const logEl = document.getElementById('checkin-log');
                document.getElementById('admin-total-count').textContent = PARTICIPANTS.length;
                document.getElementById('admin-checked-count').textContent = currentCheckins.length;

                if (currentCheckins.length === 0) {
                    logEl.innerHTML = '<p class="text-slate-400 text-center py-8">No records found</p>';
                } else {
                    logEl.innerHTML = currentCheckins.map(c => {
                        const time = new Date(c.checkedInAt).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
                        return `<div class="flex justify-between items-center bg-slate-50/50 border border-slate-100 rounded-xl px-4 py-3">
                            <div>
                                <p class="font-black text-slate-800">${c.name}</p>
                                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">${c.department || 'No Dept'}</p>
                            </div>
                            <div class="text-right max-w-[140px]">
                                <p class="text-[#9E2AB5] font-black text-xs truncate">${c.activity || 'Activity'}</p>
                                <p class="text-[10px] text-slate-300 font-bold">${time}</p>
                            </div>
                        </div>`;
                    }).join('');
                }

                // If status tab is active, refresh it too
                if (!document.getElementById('attendance-status-container').classList.contains('hidden')) {
                    renderAttendanceList();
                }
            } catch (error) {
                console.error('Failed to load check-ins:', error);
            }
        }

        // Render the full list with check-in status
        window.sortAttendance = (mode) => {
            currentSortMode = mode;
            // Update UI
            ['name', 'course', 'status'].forEach(m => {
                const btn = document.getElementById(`sort-${m}-btn`);
                if (m === mode) {
                    btn.classList.add('bg-[#00A97A]', 'text-white', 'border-[#00A97A]');
                    btn.classList.remove('bg-white', 'text-slate-400', 'border-slate-100');
                } else {
                    btn.classList.remove('bg-[#00A97A]', 'text-white', 'border-[#00A97A]');
                    btn.classList.add('bg-white', 'text-slate-400', 'border-slate-100');
                }
            });
            renderAttendanceList();
        };

        function renderAttendanceList() {
            const listEl = document.getElementById('attendance-list');

            // Map checkins by sanitized phone for quick lookup
            const checkedMap = new Map();
            currentCheckins.forEach(c => {
                const sPhone = sanitizePhoneNumber(c.phone || '');
                if (sPhone) checkedMap.set(sPhone, c);
            });

            if (PARTICIPANTS.length === 0) {
                listEl.innerHTML = '<p class="text-slate-400 text-center py-8">Upload CSV first</p>';
                return;
            }

            // Create data for sorting
            const displayData = PARTICIPANTS.map(p => {
                const sPhone = sanitizePhoneNumber(p.phone || p.휴대전화 || '');
                return {
                    ...p,
                    sPhone,
                    isChecked: checkedMap.has(sPhone)
                };
            });

            // Apply sorting
            displayData.sort((a, b) => {
                if (currentSortMode === 'course') {
                    const activityA = a.activity_name || a.액티비티 || '';
                    const activityB = b.activity_name || b.액티비티 || '';
                    return activityA.localeCompare(activityB, 'ko-KR');
                } else if (currentSortMode === 'status') {
                    if (a.isChecked === b.isChecked) {
                        return (a.name || a.이름 || '').localeCompare(b.name || b.이름 || '', 'ko-KR');
                    }
                    return a.isChecked ? 1 : -1; // Pending first (false < true)
                } else {
                    // Default: Name
                    return (a.name || a.이름 || '').localeCompare(b.name || b.이름 || '', 'ko-KR');
                }
            });

            listEl.innerHTML = displayData.map(p => {
                return `<div class="flex justify-between items-center border-b border-slate-50 py-2 px-1">
                    <div class="flex flex-col">
                        <span class="font-bold text-slate-700">${p.name || p.이름}</span>
                        <div class="flex items-center gap-1.5 mt-0.5">
                            <span class="text-[9px] text-[#9E2AB5] font-black uppercase tracking-tighter">${(p.activity_name || p.액티비티 || '').split(':')[0]}</span>
                            <span class="text-[9px] text-slate-300 font-medium">|</span>
                            <span class="text-[9px] text-slate-400 font-medium">${p.department || p.부서 || '-'}</span>
                        </div>
                    </div>
                    <div>
                        ${p.isChecked
                        ? `<span class="px-2 py-0.5 bg-[#00A97A]/10 text-[#00A97A] rounded-full text-[9px] font-black uppercase">Checked</span>`
                        : `<span class="px-2 py-0.5 bg-slate-100 text-slate-400 rounded-full text-[9px] font-black uppercase">Pending</span>`
                    }
                    </div>
                </div>`;
            }).join('');
        }

        // Clear all check-ins
        window.clearCheckins = async () => {
            if (!confirm('This will delete all check-in records. Continue?')) return;
            try {
                const checkinsRef = collection(db, 'artifacts', appId, 'public', 'data', 'checkins');
                const snapshot = await getDocs(checkinsRef);
                const batch = writeBatch(db);
                snapshot.docs.forEach(d => batch.delete(d.ref));
                await batch.commit();
                await loadCheckins();
            } catch (error) {
                console.error('Failed to clear records:', error);
            }
        };

        // Export Full Report (Attendance Status)
        window.exportFullReport = async () => {
            if (PARTICIPANTS.length === 0) {
                alert('No participant data loaded');
                return;
            }

            const checkedMap = new Map();
            currentCheckins.forEach(c => {
                const sPhone = sanitizePhoneNumber(c.phone || '');
                if (sPhone) checkedMap.set(sPhone, c);
            });

            const headers = ['Name', 'Phone', 'Department', 'Activity', 'Status', 'Check-in Time'];
            const rows = PARTICIPANTS.map(p => {
                const sPhone = sanitizePhoneNumber(p.phone || p.휴대전화 || '');
                const check = checkedMap.get(sPhone);
                return [
                    p.name || p.이름,
                    p.phone || p.휴대전화 || '',
                    p.department || p.부서 || '',
                    p.activity_name || p.액티비티 || p.bus || '',
                    check ? 'CHECKED-IN' : 'PENDING',
                    check ? new Date(check.checkedInAt).toLocaleString('ko-KR') : '-'
                ];
            });

            const csvContent = [headers, ...rows]
                .map(row => row.map(cell => `"${cell}"`).join(','))
                .join('\n');

            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `attendance_report_${new Date().toISOString().slice(0, 10)}.csv`;
            link.click();
            URL.revokeObjectURL(url);
        };

        // ============================================
        // CSV UPLOAD WITH SANITIZATION
        // ============================================
        document.getElementById('drop-zone').onclick = () => document.getElementById('csv-upload').click();
        document.getElementById('csv-upload').onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (event) => {
                const text = event.target.result;
                const lines = text.split('\n');
                const headers = lines[0].split(',').map(h => h.trim().replace(/^\uFEFF/, ''));

                const newData = [];
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;

                    const cols = line.split(',').map(c => c.trim());
                    if (cols.length < 4) continue;

                    // Map CSV columns to data object with sanitized phone
                    const participant = {
                        name: cols[headers.indexOf('이름')] || cols[0] || '',
                        department: cols[headers.indexOf('부서')] || cols[1] || '',
                        phone: sanitizePhoneNumber(cols[headers.indexOf('휴대전화')] || cols[2] || ''),
                        activity_name: cols[headers.indexOf('액티비티')] || cols[3] || '',
                        start_time: cols[headers.indexOf('출발시간')] || cols[4] || '',
                        meeting_point: cols[headers.indexOf('집합장소')] || cols[5] || '',
                        guide_info: cols[headers.indexOf('가이드 정보')] || cols[6] || '',
                        schedule_1: cols[headers.indexOf('일정 1')] || cols[7] || '',
                        schedule_2: cols[headers.indexOf('일정 2')] || cols[8] || '',
                        schedule_3: cols[headers.indexOf('일정 3')] || cols[9] || '',
                        supplies: cols[headers.indexOf('준비물')] || cols[10] || '',
                        notice: cols[headers.indexOf('주의사항')] || cols[11] || ''
                    };

                    newData.push(participant);
                }

                if (newData.length > 0) {
                    try {
                        // Delete existing participants first
                        const existingCol = collection(db, 'artifacts', appId, 'public', 'data', 'participants');
                        const existingSnapshot = await getDocs(existingCol);
                        const deleteBatch = writeBatch(db);
                        existingSnapshot.docs.forEach(d => deleteBatch.delete(d.ref));
                        await deleteBatch.commit();

                        // Add new participants
                        const addBatch = writeBatch(db);
                        newData.forEach((p, idx) => {
                            const ref = doc(db, 'artifacts', appId, 'public', 'data', 'participants', `p_${idx}`);
                            addBatch.set(ref, p);
                        });
                        await addBatch.commit();
                        await loadGlobalData();

                        document.getElementById('upload-msg').innerHTML = `<span class="text-[#00A97A]">✓ ${newData.length} participants synced!</span>`;
                        setTimeout(() => {
                            document.getElementById('upload-msg').innerHTML = '';
                        }, 3000);
                    } catch (error) {
                        console.error('Upload error:', error);
                        document.getElementById('upload-msg').innerHTML = '<span class="text-rose-500">Upload failed</span>';
                    }
                }
            };
            reader.readAsText(file);
        };

        // Initialize icons
        lucide.createIcons();
    </script>
</body>

</html>
