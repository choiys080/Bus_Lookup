<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activity Check-In Portal</title>
    <meta name="description" content="Corporate activity selection and itinerary lookup portal">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        .slide-in {
            animation: slideIn 0.4s ease-out forwards;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Timeline styling */
        .timeline-item {
            position: relative;
            padding-left: 2rem;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: 0.45rem;
            top: 1.5rem;
            width: 2px;
            height: calc(100% - 0.5rem);
            background: #e2e8f0;
        }

        .timeline-item:last-child::before {
            display: none;
        }

        .timeline-dot {
            position: absolute;
            left: 0;
            top: 0.25rem;
            width: 1rem;
            height: 1rem;
            border-radius: 50%;
            background: #00A97A;
            border: 3px solid white;
            box-shadow: 0 0 0 2px #00A97A;
        }
    </style>
</head>

<body class="bg-slate-100 min-h-screen flex items-center justify-center p-4">
    <div id="app" class="w-full max-w-md bg-white rounded-[2.5rem] shadow-2xl overflow-hidden border border-slate-200">
        <!-- Main Header: Clean White with Company Logo -->
        <div class="bg-white px-6 py-4 flex justify-between items-center border-b border-slate-100 relative">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-slate-50 rounded-lg flex items-center justify-center border border-slate-200">
                    <i data-lucide="building-2" class="w-6 h-6 text-slate-800"></i>
                </div>
                <span class="text-xs font-bold text-slate-800 tracking-wide uppercase">Company LOGO</span>
            </div>
            <div class="flex items-center gap-2">
                <div id="admin-trigger" onclick="toggleAdmin()"
                    class="cursor-pointer hover:opacity-80 transition-opacity p-2">
                    <i data-lucide="settings" class="w-5 h-5 text-slate-300"></i>
                </div>
            </div>
        </div>

        <!-- Key Visual Banner -->
        <div
            class="relative h-44 bg-slate-50 flex items-center justify-center overflow-hidden border-b border-slate-100">
            <div class="absolute inset-0 opacity-[0.03] grayscale"
                style="background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGRlZnM+PHBhdHRlcm4gaWQ9ImdyaWQiIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgcGF0dGVyblVuaXRzPSJ1c2VyU3BhY2VPblVzZSI+PHBhdGggZD0iTSAwIDEwIEwgNDAgMTAgTSAxMCAwIEwgMTAgNDAgTSAwIDIwIEwgNDAgMjAgTSAyMCAwIEwgMjAgNDAgTSAwIDMwIEwgNDAgMzAgTSAzMCAwIEwgMzAgNDAiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzAwMEZGRiIgc3Ryb2tlLXdpZHRoPSIxIi8+PC9wYXR0ZXJuPjwvZGVmcz48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDBlIiBmaWxsPSJ1cmwoI2dyaWQpIi8+PC9zdmc+');">
            </div>
            <div class="text-center z-10">
                <i data-lucide="image" class="w-12 h-12 text-slate-200 mx-auto"></i>
                <p class="text-xs text-slate-300 mt-3 font-bold uppercase tracking-[0.2em]">행사 키비주얼 이미지</p>
            </div>
        </div>

        <div class="p-8 relative" id="content-area">
            <!-- Loading View -->
            <div id="loading-view" class="flex flex-col items-center justify-center py-20 space-y-4">
                <div class="w-12 h-12 border-4 border-[#00A97A] border-t-transparent rounded-full animate-spin"></div>
                <p class="text-slate-400 font-medium text-sm">Syncing with cloud...</p>
            </div>

            <!-- Admin View -->
            <div id="admin-view" class="hidden slide-in space-y-6">
                <div class="text-center">
                    <h2 class="text-xl font-bold text-slate-800">Admin Upload</h2>
                </div>
                <div class="border-2 border-dashed border-slate-200 rounded-2xl p-8 text-center bg-slate-50 hover:border-[#00A97A] cursor-pointer transition-colors"
                    id="drop-zone">
                    <i data-lucide="upload-cloud" class="w-10 h-10 mx-auto text-slate-400 mb-2"></i>
                    <p class="text-xs text-slate-500">Click to upload Participant CSV</p>
                    <input type="file" id="csv-upload" accept=".csv" class="hidden">
                </div>
                <div id="upload-msg" class="text-center text-xs font-bold uppercase tracking-widest h-4"></div>

                <div class="border-t border-slate-100 pt-4">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-xs font-bold text-slate-700 uppercase tracking-wider">Check-in Log (<span
                                id="checkin-count">0</span>)</h3>
                    </div>
                    <div id="checkin-log" class="max-h-40 overflow-y-auto space-y-2 text-xs">
                        <p class="text-slate-400 text-center py-4">No data</p>
                    </div>
                    <div class="flex gap-2 mt-4">
                        <button onclick="exportCheckins()"
                            class="flex-1 py-2 text-[10px] font-bold text-[#00A97A] border border-[#00A97A] rounded-lg">EXPORT</button>
                        <button onclick="clearCheckins()"
                            class="flex-1 py-2 text-[10px] font-bold text-rose-500 border border-rose-100 rounded-lg">CLEAR</button>
                    </div>
                </div>

                <button onclick="showView('input-view')"
                    class="w-full py-4 bg-slate-800 text-white rounded-xl font-bold text-sm">EXIT ADMIN</button>
            </div>

            <!-- Input View (Verification) -->
            <div id="input-view" class="hidden slide-in space-y-0">
                <!-- Violet Title Bar -->
                <div class="bg-[#9E2AB5] py-3 text-center mb-10 mx-[-2rem]">
                    <h2 class="text-white font-bold text-sm tracking-[0.2em]">DAY 2 선택 Activity</h2>
                </div>

                <div class="space-y-8">
                    <div class="flex items-center gap-6">
                        <label class="w-12 text-sm font-bold text-slate-600">성명</label>
                        <input type="text" id="name-input" placeholder="성명을 입력하세요"
                            class="flex-1 px-4 py-3 bg-white border border-slate-300 rounded-lg outline-none focus:border-[#9E2AB5] transition-all text-sm">
                    </div>
                    <div class="flex items-center gap-6">
                        <label class="w-12 text-sm font-bold text-slate-600">연락처</label>
                        <input type="tel" id="phone-input" placeholder="연락처를 입력하세요"
                            class="flex-1 px-4 py-3 bg-white border border-slate-300 rounded-lg outline-none focus:border-[#9E2AB5] transition-all text-sm">
                    </div>

                    <button onclick="handleLookup()" id="find-btn"
                        class="w-full bg-white border-2 border-slate-800 text-slate-800 font-bold py-4 rounded-xl shadow-sm hover:bg-slate-50 transition-all mt-12 text-sm">
                        본인 인증
                    </button>
                </div>
            </div>

            <!-- Result View (Personal Itinerary) -->
            <div id="result-view" class="hidden slide-in space-y-0">
                <!-- User Tour Info -->
                <div class="space-y-1 text-center pb-6 mb-6 border-b border-dashed border-slate-200">
                    <h3 class="text-lg font-bold text-slate-800"><span id="res-name">User</span>님 투어 안내</h3>
                    <p id="res-dept" class="text-sm text-slate-500 font-medium"></p>
                    <p class="text-sm text-slate-600 mt-3 italic">선택투어는 <span id="res-activity-summary"
                            class="font-bold text-[#9E2AB5]">Activity</span> 입니다.</p>
                </div>

                <!-- Violet Activity Banner -->
                <div class="bg-[#9E2AB5] py-3 text-center mx-[-2rem] mb-8">
                    <h2 class="text-white font-bold text-sm tracking-widest"><span
                            id="res-activity-banner">Activity</span> 투어 안내</h2>
                </div>

                <!-- Logistics List -->
                <div class="space-y-5 text-sm">
                    <div class="flex items-center">
                        <span class="w-24 font-bold text-slate-500">출발 시간</span>
                        <span id="res-time" class="flex-1 font-bold text-slate-800">09:00</span>
                    </div>
                    <div class="flex items-center">
                        <span class="w-24 font-bold text-slate-500">집합 장소</span>
                        <span id="res-location" class="flex-1 font-bold text-slate-800">1층 로비</span>
                    </div>
                    <div class="flex items-center">
                        <span class="w-24 font-bold text-slate-500">가이드</span>
                        <span id="res-guide" class="flex-1 text-slate-700 font-medium">-</span>
                    </div>

                    <div class="pt-2">
                        <span class="block font-bold text-slate-500 mb-3">일정 요약</span>
                        <div id="timeline-container" class="space-y-3 pl-4 border-l-2 border-slate-50 ml-1">
                            <!-- Items inserted via JS -->
                        </div>
                    </div>

                    <div id="notice-box" class="pt-6 border-t border-slate-100 space-y-3 hidden">
                        <div id="notice-supplies" class="flex items-start">
                            <span class="w-24 font-bold text-slate-500 flex-shrink-0">준비물</span>
                            <span class="text-slate-700 font-medium"></span>
                        </div>
                        <div id="notice-warning" class="flex items-start">
                            <span class="w-24 font-bold text-slate-500 flex-shrink-0">주의사항</span>
                            <span class="text-slate-700 font-medium"></span>
                        </div>
                    </div>
                </div>

                <div class="pt-12 text-center">
                    <button onclick="resetApp()"
                        class="text-slate-300 text-[10px] font-bold uppercase tracking-widest hover:text-slate-500 transition-colors">
                        ← New Search
                    </button>
                </div>
            </div>

            <!-- Error View -->
            <div id="error-view" class="hidden slide-in text-center py-12 space-y-6">
                <div class="w-16 h-16 bg-rose-50 rounded-full flex items-center justify-center mx-auto">
                    <i data-lucide="info" class="w-8 h-8 text-rose-400"></i>
                </div>
                <h2 class="text-xl font-bold text-slate-800">정보를 찾을 수 없습니다</h2>
                <p class="text-sm text-slate-400">성명과 연락처를 다시 확인해 주세요.</p>
                <button onclick="showView('input-view')"
                    class="w-full bg-slate-800 text-white font-bold py-4 rounded-xl text-sm">다시 시도하기</button>
            </div>
        </div>

        <!-- App Footer -->
        <div class="bg-white border-t border-slate-100 py-6 px-8 text-center mt-auto">
            <div class="flex items-center justify-center gap-2 opacity-20 group grayscale">
                <i data-lucide="calendar-days" class="w-3 h-3 text-slate-800"></i>
                <span class="text-[9px] font-bold text-slate-800 uppercase tracking-[0.4em]">행사 logo</span>
            </div>
        </div>
    </div>

    <!-- Password Modal -->
    <div id="password-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl p-6 w-full max-w-xs shadow-2xl">
            <h3 class="text-lg font-bold text-slate-800 mb-4">Admin Access</h3>
            <input type="password" id="password-input" placeholder="Enter password"
                class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl mb-2 outline-none focus:border-[#00A97A]">
            <p id="password-error" class="hidden text-rose-500 text-sm mb-2 font-medium">Incorrect password</p>
            <div class="flex gap-3">
                <button onclick="cancelPassword()"
                    class="flex-1 py-3 bg-slate-200 text-slate-700 rounded-xl font-bold">Cancel</button>
                <button onclick="submitPassword()"
                    class="flex-1 py-3 bg-[#00A97A] text-white rounded-xl font-bold">Enter</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // PHONE SANITIZATION (Mongolian Trap)
        // ============================================
        function sanitizePhoneNumber(input) {
            if (!input) return '';
            const trimmed = input.trim();
            const hasPlus = trimmed.startsWith('+');
            let digits = input.replace(/\D/g, '');

            // Handle +82 Korean country code (e.g., +82 10-1234-5678 → 1012345678)
            if (hasPlus && digits.startsWith('82')) {
                digits = digits.substring(2);  // Remove 82 prefix
                // If it starts with 10, keep it as is (already correct format)
                if (digits.startsWith('10')) {
                    return digits;  // 1012345678
                }
                // If it starts with 010, strip the leading 0
                if (digits.startsWith('010')) {
                    return digits.substring(1);  // 1012345678
                }
                return digits;
            }

            // Handle other international numbers (keep + prefix)
            if (hasPlus) {
                return '+' + digits;  // +97699990815
            }

            // Handle Korean 010 prefix
            if (digits.startsWith('010')) {
                return digits.substring(1);  // 1012345678
            }

            return digits;
        }

        // ============================================
        // ADMIN PASSWORD HANDLING
        // ============================================
        const ADMIN_PASSWORD = 'admin123';

        function toggleAdmin() {
            const adminView = document.getElementById('admin-view');

            // If already in admin mode, just exit
            if (adminView && !adminView.classList.contains('hidden')) {
                window.showView ? window.showView('input-view') : location.reload();
                return;
            }

            // Show password modal
            document.getElementById('password-modal').classList.remove('hidden');
            document.getElementById('password-input').value = '';
            document.getElementById('password-input').focus();
        }

        function submitPassword() {
            const password = document.getElementById('password-input').value;
            const errorEl = document.getElementById('password-error');

            if (password !== ADMIN_PASSWORD) {
                errorEl.classList.remove('hidden');
                const inputEl = document.getElementById('password-input');
                inputEl.classList.add('border-rose-500');
                inputEl.value = '';
                inputEl.focus();
                return;
            }

            // Hide modal and error
            document.getElementById('password-modal').classList.add('hidden');
            errorEl.classList.add('hidden');

            // Show admin view
            if (window.showView) {
                window.showView('admin-view');
            } else {
                document.querySelectorAll('#loading-view, #input-view, #result-view, #error-view').forEach(el => el.classList.add('hidden'));
                document.getElementById('admin-view').classList.remove('hidden');
            }
        }

        function cancelPassword() {
            document.getElementById('password-modal').classList.add('hidden');
        }

        // Allow Enter key to submit password
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('password-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') submitPassword();
            });
        });
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDocs, writeBatch, addDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = typeof __firebase_config !== 'undefined'
            ? JSON.parse(__firebase_config)
            : {
                apiKey: "AIzaSyAnp90bFTz6_E7r0tBPAYKu58GbwQqto0I",
                authDomain: "buslookup-5fd0d.firebaseapp.com",
                projectId: "buslookup-5fd0d",
                storageBucket: "buslookup-5fd0d.firebasestorage.app",
                messagingSenderId: "981605729788",
                appId: "1:981605729788:web:942a2188f3985433659e79",
                measurementId: "G-SXL79P93YD"
            };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let PARTICIPANTS = [];
        let currentUser = null;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                await loadGlobalData();
                showView('input-view');
            } else {
                await signInAnonymously(auth);
            }
        });

        async function loadGlobalData() {
            if (!currentUser) return;
            try {
                const dataCol = collection(db, 'artifacts', appId, 'public', 'data', 'participants');
                const snapshot = await getDocs(dataCol);
                PARTICIPANTS = snapshot.docs.map(d => d.data());
                console.log(`Loaded ${PARTICIPANTS.length} participants`);
            } catch (error) {
                console.log('Cloud sync not available, running in local mode');
                showView('input-view');
            }
        }

        window.showView = (id) => {
            ['loading-view', 'admin-view', 'input-view', 'result-view', 'error-view'].forEach(v => document.getElementById(v).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            lucide.createIcons();
            if (id === 'admin-view') loadCheckins();
        };

        // ============================================
        // PHONE-ONLY LOOKUP (Name is cosmetic)
        // ============================================
        window.handleLookup = async () => {
            const nameInput = document.getElementById('name-input').value.trim();
            const phoneInput = document.getElementById('phone-input').value;
            const sanitizedPhone = sanitizePhoneNumber(phoneInput);

            // Phone-only lookup - find by sanitized phone number
            const user = PARTICIPANTS.find(u => {
                const storedPhone = sanitizePhoneNumber(u.phone || u.휴대전화 || '');
                return storedPhone === sanitizedPhone;
            });

            if (user) {
                // Display user info
                const activityName = user.activity_name || user.액티비티 || user.bus || 'Activity';
                document.getElementById('res-name').textContent = user.name || user.이름 || nameInput;
                document.getElementById('res-dept').textContent = user.department || user.부서 || '';
                document.getElementById('res-activity-summary').textContent = activityName;
                document.getElementById('res-activity-banner').textContent = activityName;
                document.getElementById('res-time').textContent = user.start_time || user.출발시간 || user.time || '-';
                document.getElementById('res-location').textContent = user.meeting_point || user.집합장소 || '-';
                document.getElementById('res-guide').textContent = user.guide_info || user['가이드 정보'] || '-';

                // Build timeline
                const timelineContainer = document.getElementById('timeline-container');
                const schedules = [
                    user.schedule_1 || user['일정 1'],
                    user.schedule_2 || user['일정 2'],
                    user.schedule_3 || user['일정 3']
                ].filter(s => s && s.trim());

                if (schedules.length > 0) {
                    timelineContainer.innerHTML = schedules.map((s, idx) => `
                        <div class="flex gap-3 text-slate-700">
                            <span class="font-bold text-slate-300">${idx + 1}</span>
                            <p class="font-medium">${s}</p>
                        </div>
                    `).join('');
                } else {
                    timelineContainer.innerHTML = '<p class="text-slate-400 text-xs">No schedule available</p>';
                }

                // Handle notice box
                const supplies = user.supplies || user.준비물 || '';
                const notice = user.notice || user.주의사항 || '';
                const noticeBox = document.getElementById('notice-box');

                if (supplies || notice) {
                    noticeBox.classList.remove('hidden');
                    noticeBox.querySelector('#notice-supplies span').textContent = supplies || '-';
                    noticeBox.querySelector('#notice-warning span').textContent = notice || '-';
                    noticeBox.querySelector('#notice-supplies').style.display = supplies ? 'flex' : 'none';
                    noticeBox.querySelector('#notice-warning').style.display = notice ? 'flex' : 'none';
                } else {
                    noticeBox.classList.add('hidden');
                }

                showView('result-view');

                // Log check-in to Firebase
                try {
                    const checkinsRef = collection(db, 'artifacts', appId, 'public', 'data', 'checkins');
                    await addDoc(checkinsRef, {
                        name: user.name || user.이름 || nameInput,
                        phone: sanitizedPhone,
                        activity: user.activity_name || user.액티비티 || user.bus,
                        department: user.department || user.부서 || '',
                        checkedInAt: new Date().toISOString()
                    });
                } catch (error) {
                    console.log('Check-in logging failed:', error);
                }
            } else {
                showView('error-view');
            }
        };

        window.resetApp = () => {
            document.getElementById('name-input').value = '';
            document.getElementById('phone-input').value = '';
            showView('input-view');
        };

        // Load check-ins for admin view
        async function loadCheckins() {
            try {
                const checkinsRef = collection(db, 'artifacts', appId, 'public', 'data', 'checkins');
                const q = query(checkinsRef, orderBy('checkedInAt', 'desc'));
                const snapshot = await getDocs(q);
                const checkins = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));

                const logEl = document.getElementById('checkin-log');
                const countEl = document.getElementById('checkin-count');
                countEl.textContent = checkins.length;

                if (checkins.length === 0) {
                    logEl.innerHTML = '<p class="text-slate-400 text-center text-xs py-4">No check-ins yet</p>';
                } else {
                    logEl.innerHTML = checkins.map(c => {
                        const time = new Date(c.checkedInAt).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
                        return `<div class="flex justify-between items-center bg-slate-50 rounded-lg px-3 py-2">
                            <div>
                                <span class="font-medium text-slate-700">${c.name}</span>
                                <span class="text-slate-400 text-xs ml-2">${c.department || ''}</span>
                            </div>
                            <div class="text-right">
                                <span class="text-[#9E2AB5] font-bold text-xs">${c.activity || ''}</span>
                                <span class="text-slate-400 text-xs ml-1">${time}</span>
                            </div>
                        </div>`;
                    }).join('');
                }
            } catch (error) {
                console.log('Failed to load check-ins:', error);
            }
        }

        // Clear all check-ins
        window.clearCheckins = async () => {
            if (!confirm('Clear all check-in records?')) return;
            try {
                const checkinsRef = collection(db, 'artifacts', appId, 'public', 'data', 'checkins');
                const snapshot = await getDocs(checkinsRef);
                const batch = writeBatch(db);
                snapshot.docs.forEach(d => batch.delete(d.ref));
                await batch.commit();
                await loadCheckins();
            } catch (error) {
                console.log('Failed to clear check-ins:', error);
            }
        };

        // Export check-ins as CSV
        window.exportCheckins = async () => {
            try {
                const checkinsRef = collection(db, 'artifacts', appId, 'public', 'data', 'checkins');
                const q = query(checkinsRef, orderBy('checkedInAt', 'desc'));
                const snapshot = await getDocs(q);
                const checkins = snapshot.docs.map(d => d.data());

                if (checkins.length === 0) {
                    alert('No check-ins to export');
                    return;
                }

                // Create CSV content
                const headers = ['Name', 'Phone', 'Department', 'Activity', 'Checked In At'];
                const rows = checkins.map(c => [
                    c.name,
                    c.phone,
                    c.department || '',
                    c.activity || '',
                    new Date(c.checkedInAt).toLocaleString('ko-KR')
                ]);

                const csvContent = [headers, ...rows]
                    .map(row => row.map(cell => `"${cell}"`).join(','))
                    .join('\n');

                // Download file
                const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `checkins_${new Date().toISOString().slice(0, 10)}.csv`;
                link.click();
                URL.revokeObjectURL(url);
            } catch (error) {
                console.log('Failed to export check-ins:', error);
                alert('Export failed');
            }
        };

        // ============================================
        // CSV UPLOAD WITH SANITIZATION
        // ============================================
        document.getElementById('drop-zone').onclick = () => document.getElementById('csv-upload').click();
        document.getElementById('csv-upload').onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (event) => {
                const text = event.target.result;
                const lines = text.split('\n');
                const headers = lines[0].split(',').map(h => h.trim().replace(/^\uFEFF/, ''));

                const newData = [];
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;

                    const cols = line.split(',').map(c => c.trim());
                    if (cols.length < 4) continue;

                    // Map CSV columns to data object with sanitized phone
                    const participant = {
                        name: cols[headers.indexOf('이름')] || cols[0] || '',
                        department: cols[headers.indexOf('부서')] || cols[1] || '',
                        phone: sanitizePhoneNumber(cols[headers.indexOf('휴대전화')] || cols[2] || ''),
                        activity_name: cols[headers.indexOf('액티비티')] || cols[3] || '',
                        start_time: cols[headers.indexOf('출발시간')] || cols[4] || '',
                        meeting_point: cols[headers.indexOf('집합장소')] || cols[5] || '',
                        guide_info: cols[headers.indexOf('가이드 정보')] || cols[6] || '',
                        schedule_1: cols[headers.indexOf('일정 1')] || cols[7] || '',
                        schedule_2: cols[headers.indexOf('일정 2')] || cols[8] || '',
                        schedule_3: cols[headers.indexOf('일정 3')] || cols[9] || '',
                        supplies: cols[headers.indexOf('준비물')] || cols[10] || '',
                        notice: cols[headers.indexOf('주의사항')] || cols[11] || ''
                    };

                    newData.push(participant);
                }

                if (newData.length > 0) {
                    try {
                        // Delete existing participants first
                        const existingCol = collection(db, 'artifacts', appId, 'public', 'data', 'participants');
                        const existingSnapshot = await getDocs(existingCol);
                        const deleteBatch = writeBatch(db);
                        existingSnapshot.docs.forEach(d => deleteBatch.delete(d.ref));
                        await deleteBatch.commit();

                        // Add new participants
                        const addBatch = writeBatch(db);
                        newData.forEach((p, idx) => {
                            const ref = doc(db, 'artifacts', appId, 'public', 'data', 'participants', `p_${idx}`);
                            addBatch.set(ref, p);
                        });
                        await addBatch.commit();
                        await loadGlobalData();

                        document.getElementById('upload-msg').innerHTML = `<span class="text-[#00A97A]">✓ ${newData.length} participants synced!</span>`;
                        setTimeout(() => {
                            document.getElementById('upload-msg').innerHTML = '';
                        }, 3000);
                    } catch (error) {
                        console.error('Upload error:', error);
                        document.getElementById('upload-msg').innerHTML = '<span class="text-rose-500">Upload failed</span>';
                    }
                }
            };
            reader.readAsText(file);
        };

        // Initialize icons
        lucide.createIcons();
    </script>
</body>

</html>
