<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activity Check-In Portal</title>
    <meta name="description" content="Corporate activity selection and itinerary lookup portal">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        .slide-in {
            animation: slideIn 0.4s ease-out forwards;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Timeline styling */
        .timeline-item {
            position: relative;
            padding-left: 2rem;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: 0.45rem;
            top: 1.5rem;
            width: 2px;
            height: calc(100% - 0.5rem);
            background: #e2e8f0;
        }

        .timeline-item:last-child::before {
            display: none;
        }

        .timeline-dot {
            position: absolute;
            left: 0;
            top: 0.25rem;
            width: 1rem;
            height: 1rem;
            border-radius: 50%;
            background: #00A97A;
            border: 3px solid white;
            box-shadow: 0 0 0 2px #00A97A;
        }
    </style>
</head>

<body class="bg-slate-100 min-h-screen flex items-center justify-center p-4">
    <div id="app" class="w-full max-w-md bg-white rounded-[2.5rem] shadow-2xl overflow-hidden border border-slate-200">
        <!-- Header with BB Green + Company Logo -->
        <div class="bg-[#00A97A] p-6 text-white relative">
            <!-- Logo Row -->
            <div class="flex justify-between items-center mb-4">
                <!-- Company Logo Placeholder -->
                <div class="flex items-center gap-3">
                    <div
                        class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center backdrop-blur-sm border border-white/30">
                        <i data-lucide="building-2" class="w-6 h-6 text-white/80"></i>
                    </div>
                    <span class="text-sm font-bold text-white/90 tracking-wide">B.BRAUN</span>
                </div>
                <!-- Event Logo Placeholder -->
                <div class="flex items-center gap-2">
                    <div
                        class="px-3 py-1 bg-white/20 rounded-full text-[10px] font-bold tracking-wider backdrop-blur-sm border border-white/30">
                        DAY 2
                    </div>
                    <div id="admin-trigger" onclick="toggleAdmin()"
                        class="cursor-pointer hover:opacity-80 transition-opacity ml-2">
                        <i data-lucide="settings" class="w-5 h-5 opacity-50"></i>
                    </div>
                </div>
            </div>
            <!-- Event Title -->
            <div class="text-center">
                <h1 class="text-2xl font-bold tracking-tight">선택 Activity</h1>
                <p class="text-emerald-100 opacity-80 text-sm mt-1">Corporate Event 2024</p>
            </div>
        </div>

        <!-- Key Visual Banner (Placeholder) -->
        <div
            class="relative h-32 bg-gradient-to-br from-[#00A97A]/20 via-[#9E2AB5]/10 to-[#00A97A]/20 flex items-center justify-center overflow-hidden">
            <div
                class="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGRlZnM+PHBhdHRlcm4gaWQ9ImdyaWQiIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgcGF0dGVyblVuaXRzPSJ1c2VyU3BhY2VPblVzZSI+PHBhdGggZD0iTSAwIDEwIEwgNDAgMTAgTSAxMCAwIEwgMTAgNDAgTSAwIDIwIEwgNDAgMjAgTSAyMCAwIEwgMjAgNDAgTSAwIDMwIEwgNDAgMzAgTSAzMCAwIEwgMzAgNDAiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzAwQTk3QSIgc3Ryb2tlLW9wYWNpdHk9IjAuMDUiIHN0cm9rZS13aWR0aD0iMSIvPjwvcGF0dGVybj48L2RlZnM+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0idXJsKCNncmlkKSIvPjwvc3ZnPg==')] opacity-50">
            </div>
            <div class="text-center z-10">
                <div class="flex items-center justify-center gap-2 text-[#00A97A]">
                    <i data-lucide="image" class="w-8 h-8 opacity-40"></i>
                </div>
                <p class="text-[10px] text-slate-400 mt-2 font-medium uppercase tracking-widest">Event Key Visual</p>
            </div>
        </div>

        <div class="p-8" id="content-area">
            <!-- Loading View -->
            <div id="loading-view" class="flex flex-col items-center justify-center py-12 space-y-4">
                <div class="w-12 h-12 border-4 border-[#00A97A] border-t-transparent rounded-full animate-spin"></div>
                <p class="text-slate-400 font-medium text-sm">Syncing with cloud...</p>
            </div>

            <!-- Admin View -->
            <div id="admin-view" class="hidden slide-in space-y-6">
                <div class="text-center">
                    <h2 class="text-xl font-bold text-slate-800">Admin Upload</h2>
                </div>
                <div class="border-2 border-dashed border-slate-200 rounded-2xl p-8 text-center bg-slate-50 hover:border-[#00A97A] cursor-pointer transition-colors"
                    id="drop-zone">
                    <i data-lucide="upload-cloud" class="w-10 h-10 mx-auto text-slate-400 mb-2"></i>
                    <p class="text-xs text-slate-500">Click to upload Participant CSV</p>
                    <input type="file" id="csv-upload" accept=".csv" class="hidden">
                </div>
                <div id="upload-msg" class="text-center text-xs font-bold uppercase tracking-widest"></div>

                <!-- Check-in Log Section -->
                <div class="border-t border-slate-200 pt-4">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-sm font-bold text-slate-700 flex items-center gap-2">
                            <i data-lucide="clipboard-list" class="w-4 h-4"></i>
                            Check-in Log
                        </h3>
                        <span id="checkin-count" class="text-xs bg-[#00A97A] text-white px-2 py-1 rounded-full">0</span>
                    </div>
                    <div id="checkin-log" class="max-h-48 overflow-y-auto space-y-2 text-sm">
                        <p class="text-slate-400 text-center text-xs py-4">No check-ins yet</p>
                    </div>
                    <div class="flex gap-2 mt-3">
                        <button onclick="exportCheckins()"
                            class="flex-1 py-2 text-xs text-[#00A97A] border border-[#00A97A] rounded-lg hover:bg-[#00A97A] hover:text-white transition-colors">
                            Export CSV
                        </button>
                        <button onclick="clearCheckins()"
                            class="flex-1 py-2 text-xs text-slate-400 border border-slate-200 rounded-lg hover:text-rose-500 hover:border-rose-500 transition-colors">
                            Clear All
                        </button>
                    </div>
                </div>

                <button onclick="toggleAdmin()"
                    class="w-full py-4 bg-slate-800 text-white rounded-2xl font-bold text-sm hover:bg-slate-700 transition-colors">Exit
                    Admin Mode</button>
            </div>

            <!-- Input View (Login) -->
            <div id="input-view" class="hidden space-y-6">
                <div class="text-center space-y-2">
                    <h2 class="text-2xl font-extrabold text-slate-800">Welcome</h2>
                    <p class="text-slate-500">Enter your info to see your itinerary.</p>
                </div>
                <div class="space-y-4">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold uppercase tracking-[0.2em] text-slate-400">Full Name</label>
                        <div class="relative">
                            <i data-lucide="user"
                                class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400"></i>
                            <input type="text" id="name-input" placeholder="홍길동"
                                class="w-full pl-12 pr-4 py-4 bg-slate-50 border border-slate-200 rounded-2xl outline-none focus:border-[#00A97A] focus:ring-2 focus:ring-[#00A97A]/20 transition-all">
                        </div>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold uppercase tracking-[0.2em] text-slate-400">Phone
                            Number</label>
                        <div class="relative">
                            <i data-lucide="phone"
                                class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400"></i>
                            <input type="tel" id="phone-input" placeholder="010-1234-5678"
                                class="w-full pl-12 pr-4 py-4 bg-slate-50 border border-slate-200 rounded-2xl outline-none focus:border-[#00A97A] focus:ring-2 focus:ring-[#00A97A]/20 transition-all">
                        </div>
                        <p class="text-[10px] text-slate-400 pl-1">Phone number is used for verification only</p>
                    </div>
                    <button onclick="handleLookup()" id="find-btn"
                        class="w-full bg-[#00A97A] text-white font-bold py-5 rounded-2xl shadow-lg hover:bg-[#008c66] active:scale-[0.98] transition-all">
                        Check My Itinerary
                    </button>
                </div>
            </div>

            <!-- Result View (Personal Itinerary) -->
            <div id="result-view" class="hidden slide-in space-y-6">
                <!-- Welcome Header -->
                <div class="flex flex-col items-center text-center">
                    <div
                        class="w-16 h-16 bg-emerald-100 rounded-full flex items-center justify-center text-[#00A97A] mb-3">
                        <i data-lucide="check-circle-2" class="w-8 h-8"></i>
                    </div>
                    <p class="text-slate-500">Welcome, <span id="res-name" class="font-bold text-slate-800">User</span>
                    </p>
                    <p id="res-dept" class="text-sm text-slate-400"></p>
                </div>

                <!-- Activity Title (BB Violet) -->
                <div
                    class="bg-gradient-to-r from-[#9E2AB5]/10 to-[#9E2AB5]/5 rounded-2xl p-6 text-center border border-[#9E2AB5]/20">
                    <div class="flex items-center justify-center gap-2 mb-2">
                        <i data-lucide="map" class="w-5 h-5 text-[#9E2AB5]"></i>
                        <span class="text-[10px] uppercase font-bold tracking-widest text-[#9E2AB5]">Your
                            Activity</span>
                    </div>
                    <h2 id="res-activity" class="text-2xl font-black text-[#9E2AB5]">Activity Name</h2>
                </div>

                <!-- Logistics Card -->
                <div class="bg-slate-50 border border-slate-200 rounded-2xl p-6 space-y-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-[10px] uppercase text-slate-400 font-bold tracking-wider mb-1">Departure Time
                            </p>
                            <p id="res-time" class="text-2xl font-black text-[#00A97A]">09:00</p>
                        </div>
                        <div class="text-right">
                            <p class="text-[10px] uppercase text-slate-400 font-bold tracking-wider mb-1">Meeting Point
                            </p>
                            <p id="res-location" class="text-lg font-bold text-slate-700">1층 로비</p>
                        </div>
                    </div>
                    <div class="border-t border-slate-200 pt-4">
                        <p class="text-[10px] uppercase text-slate-400 font-bold tracking-wider mb-1">Guide Info</p>
                        <p id="res-guide" class="text-sm font-medium text-slate-600">-</p>
                    </div>
                </div>

                <!-- Timeline -->
                <div class="space-y-3">
                    <div class="flex items-center gap-2">
                        <i data-lucide="route" class="w-4 h-4 text-[#00A97A]"></i>
                        <span class="text-[10px] uppercase font-bold tracking-widest text-slate-400">Schedule</span>
                    </div>
                    <div id="timeline-container" class="space-y-4 pl-2">
                        <!-- Timeline items will be inserted here -->
                    </div>
                </div>

                <!-- Notice Box -->
                <div id="notice-box" class="bg-amber-50 border-2 border-amber-200 rounded-2xl p-5 space-y-3">
                    <div class="flex items-center gap-2 text-amber-700">
                        <i data-lucide="alert-triangle" class="w-5 h-5"></i>
                        <span class="text-sm font-bold uppercase tracking-wide">Notice</span>
                    </div>
                    <div class="space-y-2 text-sm text-amber-800">
                        <div id="notice-supplies" class="flex items-start gap-2">
                            <i data-lucide="backpack" class="w-4 h-4 mt-0.5 text-amber-600"></i>
                            <span></span>
                        </div>
                        <div id="notice-warning" class="flex items-start gap-2">
                            <i data-lucide="info" class="w-4 h-4 mt-0.5 text-amber-600"></i>
                            <span></span>
                        </div>
                    </div>
                </div>

                <button onclick="resetApp()"
                    class="w-full py-3 text-slate-400 font-bold text-sm hover:text-slate-600 transition-colors">
                    ← New Search
                </button>
            </div>

            <!-- Error View -->
            <div id="error-view" class="hidden slide-in text-center space-y-6">
                <div class="w-20 h-20 bg-rose-100 rounded-full flex items-center justify-center mx-auto">
                    <i data-lucide="alert-circle" class="w-10 h-10 text-rose-500"></i>
                </div>
                <h2 class="text-2xl font-extrabold text-slate-800">No Record Found</h2>
                <p class="text-slate-500">Phone number not found. Please check with the information desk.</p>
                <button onclick="resetApp()"
                    class="w-full bg-slate-800 text-white font-bold py-5 rounded-2xl hover:bg-slate-700 transition-colors">Try
                    Again</button>
            </div>
        </div>
        <div class="bg-slate-50 border-t border-slate-100 py-6 text-center cursor-default select-none">
            <p class="text-[9px] text-slate-300 uppercase tracking-[0.3em] font-black">Secure Cloud Portal v5.0</p>
        </div>
    </div>

    <!-- Password Modal -->
    <div id="password-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl p-6 w-full max-w-xs shadow-2xl">
            <h3 class="text-lg font-bold text-slate-800 mb-4">Admin Access</h3>
            <input type="password" id="password-input" placeholder="Enter password"
                class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl mb-2 outline-none focus:border-[#00A97A]">
            <p id="password-error" class="hidden text-rose-500 text-sm mb-2 font-medium">Incorrect password</p>
            <div class="flex gap-3">
                <button onclick="cancelPassword()"
                    class="flex-1 py-3 bg-slate-200 text-slate-700 rounded-xl font-bold">Cancel</button>
                <button onclick="submitPassword()"
                    class="flex-1 py-3 bg-[#00A97A] text-white rounded-xl font-bold">Enter</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // PHONE SANITIZATION (Mongolian Trap)
        // ============================================
        function sanitizePhoneNumber(input) {
            if (!input) return '';
            const hasPlus = input.trim().startsWith('+');
            const digits = input.replace(/\D/g, '');

            if (hasPlus) {
                return '+' + digits;  // +97699990815
            }

            if (digits.startsWith('010')) {
                return digits.substring(1);  // 1012345678
            }

            return digits;
        }

        // ============================================
        // ADMIN PASSWORD HANDLING
        // ============================================
        const ADMIN_PASSWORD = 'admin123';

        function toggleAdmin() {
            const adminView = document.getElementById('admin-view');

            // If already in admin mode, just exit
            if (adminView && !adminView.classList.contains('hidden')) {
                window.showView ? window.showView('input-view') : location.reload();
                return;
            }

            // Show password modal
            document.getElementById('password-modal').classList.remove('hidden');
            document.getElementById('password-input').value = '';
            document.getElementById('password-input').focus();
        }

        function submitPassword() {
            const password = document.getElementById('password-input').value;
            const errorEl = document.getElementById('password-error');

            if (password !== ADMIN_PASSWORD) {
                errorEl.classList.remove('hidden');
                const inputEl = document.getElementById('password-input');
                inputEl.classList.add('border-rose-500');
                inputEl.value = '';
                inputEl.focus();
                return;
            }

            // Hide modal and error
            document.getElementById('password-modal').classList.add('hidden');
            errorEl.classList.add('hidden');

            // Show admin view
            if (window.showView) {
                window.showView('admin-view');
            } else {
                document.querySelectorAll('#loading-view, #input-view, #result-view, #error-view').forEach(el => el.classList.add('hidden'));
                document.getElementById('admin-view').classList.remove('hidden');
            }
        }

        function cancelPassword() {
            document.getElementById('password-modal').classList.add('hidden');
        }

        // Allow Enter key to submit password
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('password-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') submitPassword();
            });
        });
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDocs, writeBatch, addDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = typeof __firebase_config !== 'undefined'
            ? JSON.parse(__firebase_config)
            : {
                apiKey: "AIzaSyAnp90bFTz6_E7r0tBPAYKu58GbwQqto0I",
                authDomain: "buslookup-5fd0d.firebaseapp.com",
                projectId: "buslookup-5fd0d",
                storageBucket: "buslookup-5fd0d.firebasestorage.app",
                messagingSenderId: "981605729788",
                appId: "1:981605729788:web:942a2188f3985433659e79",
                measurementId: "G-SXL79P93YD"
            };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let PARTICIPANTS = [];
        let currentUser = null;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                await loadGlobalData();
                showView('input-view');
            } else {
                await signInAnonymously(auth);
            }
        });

        async function loadGlobalData() {
            if (!currentUser) return;
            try {
                const dataCol = collection(db, 'artifacts', appId, 'public', 'data', 'participants');
                const snapshot = await getDocs(dataCol);
                PARTICIPANTS = snapshot.docs.map(d => d.data());
                console.log(`Loaded ${PARTICIPANTS.length} participants`);
            } catch (error) {
                console.log('Cloud sync not available, running in local mode');
                showView('input-view');
            }
        }

        window.showView = (id) => {
            ['loading-view', 'admin-view', 'input-view', 'result-view', 'error-view'].forEach(v => document.getElementById(v).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            lucide.createIcons();
            if (id === 'admin-view') loadCheckins();
        };

        // ============================================
        // PHONE-ONLY LOOKUP (Name is cosmetic)
        // ============================================
        window.handleLookup = async () => {
            const nameInput = document.getElementById('name-input').value.trim();
            const phoneInput = document.getElementById('phone-input').value;
            const sanitizedPhone = sanitizePhoneNumber(phoneInput);

            // Phone-only lookup - find by sanitized phone number
            const user = PARTICIPANTS.find(u => {
                const storedPhone = sanitizePhoneNumber(u.phone || u.휴대전화 || '');
                return storedPhone === sanitizedPhone;
            });

            if (user) {
                // Display user info
                document.getElementById('res-name').textContent = user.name || user.이름 || nameInput;
                document.getElementById('res-dept').textContent = user.department || user.부서 || '';
                document.getElementById('res-activity').textContent = user.activity_name || user.액티비티 || user.bus || 'Activity';
                document.getElementById('res-time').textContent = user.start_time || user.출발시간 || user.time || '-';
                document.getElementById('res-location').textContent = user.meeting_point || user.집합장소 || '-';
                document.getElementById('res-guide').textContent = user.guide_info || user['가이드 정보'] || '-';

                // Build timeline
                const timelineContainer = document.getElementById('timeline-container');
                const schedules = [
                    user.schedule_1 || user['일정 1'],
                    user.schedule_2 || user['일정 2'],
                    user.schedule_3 || user['일정 3']
                ].filter(s => s && s.trim());

                if (schedules.length > 0) {
                    timelineContainer.innerHTML = schedules.map(s => `
                        <div class="timeline-item">
                            <div class="timeline-dot"></div>
                            <p class="text-slate-700 font-medium">${s}</p>
                        </div>
                    `).join('');
                } else {
                    timelineContainer.innerHTML = '<p class="text-slate-400 text-sm">No schedule available</p>';
                }

                // Handle notice box
                const supplies = user.supplies || user.준비물 || '';
                const notice = user.notice || user.주의사항 || '';
                const noticeBox = document.getElementById('notice-box');

                if (supplies || notice) {
                    noticeBox.classList.remove('hidden');
                    document.querySelector('#notice-supplies span').textContent = supplies ? `준비물: ${supplies}` : '';
                    document.querySelector('#notice-warning span').textContent = notice ? `주의: ${notice}` : '';
                    document.getElementById('notice-supplies').style.display = supplies ? 'flex' : 'none';
                    document.getElementById('notice-warning').style.display = notice ? 'flex' : 'none';
                } else {
                    noticeBox.classList.add('hidden');
                }

                showView('result-view');

                // Log check-in to Firebase
                try {
                    const checkinsRef = collection(db, 'artifacts', appId, 'public', 'data', 'checkins');
                    await addDoc(checkinsRef, {
                        name: user.name || user.이름 || nameInput,
                        phone: sanitizedPhone,
                        activity: user.activity_name || user.액티비티 || user.bus,
                        department: user.department || user.부서 || '',
                        checkedInAt: new Date().toISOString()
                    });
                } catch (error) {
                    console.log('Check-in logging failed:', error);
                }
            } else {
                showView('error-view');
            }
        };

        window.resetApp = () => {
            document.getElementById('name-input').value = '';
            document.getElementById('phone-input').value = '';
            showView('input-view');
        };

        // Load check-ins for admin view
        async function loadCheckins() {
            try {
                const checkinsRef = collection(db, 'artifacts', appId, 'public', 'data', 'checkins');
                const q = query(checkinsRef, orderBy('checkedInAt', 'desc'));
                const snapshot = await getDocs(q);
                const checkins = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));

                const logEl = document.getElementById('checkin-log');
                const countEl = document.getElementById('checkin-count');
                countEl.textContent = checkins.length;

                if (checkins.length === 0) {
                    logEl.innerHTML = '<p class="text-slate-400 text-center text-xs py-4">No check-ins yet</p>';
                } else {
                    logEl.innerHTML = checkins.map(c => {
                        const time = new Date(c.checkedInAt).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
                        return `<div class="flex justify-between items-center bg-slate-50 rounded-lg px-3 py-2">
                            <div>
                                <span class="font-medium text-slate-700">${c.name}</span>
                                <span class="text-slate-400 text-xs ml-2">${c.department || ''}</span>
                            </div>
                            <div class="text-right">
                                <span class="text-[#9E2AB5] font-bold text-xs">${c.activity || ''}</span>
                                <span class="text-slate-400 text-xs ml-1">${time}</span>
                            </div>
                        </div>`;
                    }).join('');
                }
            } catch (error) {
                console.log('Failed to load check-ins:', error);
            }
        }

        // Clear all check-ins
        window.clearCheckins = async () => {
            if (!confirm('Clear all check-in records?')) return;
            try {
                const checkinsRef = collection(db, 'artifacts', appId, 'public', 'data', 'checkins');
                const snapshot = await getDocs(checkinsRef);
                const batch = writeBatch(db);
                snapshot.docs.forEach(d => batch.delete(d.ref));
                await batch.commit();
                await loadCheckins();
            } catch (error) {
                console.log('Failed to clear check-ins:', error);
            }
        };

        // Export check-ins as CSV
        window.exportCheckins = async () => {
            try {
                const checkinsRef = collection(db, 'artifacts', appId, 'public', 'data', 'checkins');
                const q = query(checkinsRef, orderBy('checkedInAt', 'desc'));
                const snapshot = await getDocs(q);
                const checkins = snapshot.docs.map(d => d.data());

                if (checkins.length === 0) {
                    alert('No check-ins to export');
                    return;
                }

                // Create CSV content
                const headers = ['Name', 'Phone', 'Department', 'Activity', 'Checked In At'];
                const rows = checkins.map(c => [
                    c.name,
                    c.phone,
                    c.department || '',
                    c.activity || '',
                    new Date(c.checkedInAt).toLocaleString('ko-KR')
                ]);

                const csvContent = [headers, ...rows]
                    .map(row => row.map(cell => `"${cell}"`).join(','))
                    .join('\n');

                // Download file
                const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `checkins_${new Date().toISOString().slice(0, 10)}.csv`;
                link.click();
                URL.revokeObjectURL(url);
            } catch (error) {
                console.log('Failed to export check-ins:', error);
                alert('Export failed');
            }
        };

        // ============================================
        // CSV UPLOAD WITH SANITIZATION
        // ============================================
        document.getElementById('drop-zone').onclick = () => document.getElementById('csv-upload').click();
        document.getElementById('csv-upload').onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (event) => {
                const text = event.target.result;
                const lines = text.split('\n');
                const headers = lines[0].split(',').map(h => h.trim().replace(/^\uFEFF/, ''));

                const newData = [];
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;

                    const cols = line.split(',').map(c => c.trim());
                    if (cols.length < 4) continue;

                    // Map CSV columns to data object with sanitized phone
                    const participant = {
                        name: cols[headers.indexOf('이름')] || cols[0] || '',
                        department: cols[headers.indexOf('부서')] || cols[1] || '',
                        phone: sanitizePhoneNumber(cols[headers.indexOf('휴대전화')] || cols[2] || ''),
                        activity_name: cols[headers.indexOf('액티비티')] || cols[3] || '',
                        start_time: cols[headers.indexOf('출발시간')] || cols[4] || '',
                        meeting_point: cols[headers.indexOf('집합장소')] || cols[5] || '',
                        guide_info: cols[headers.indexOf('가이드 정보')] || cols[6] || '',
                        schedule_1: cols[headers.indexOf('일정 1')] || cols[7] || '',
                        schedule_2: cols[headers.indexOf('일정 2')] || cols[8] || '',
                        schedule_3: cols[headers.indexOf('일정 3')] || cols[9] || '',
                        supplies: cols[headers.indexOf('준비물')] || cols[10] || '',
                        notice: cols[headers.indexOf('주의사항')] || cols[11] || ''
                    };

                    newData.push(participant);
                }

                if (newData.length > 0) {
                    try {
                        // Delete existing participants first
                        const existingCol = collection(db, 'artifacts', appId, 'public', 'data', 'participants');
                        const existingSnapshot = await getDocs(existingCol);
                        const deleteBatch = writeBatch(db);
                        existingSnapshot.docs.forEach(d => deleteBatch.delete(d.ref));
                        await deleteBatch.commit();

                        // Add new participants
                        const addBatch = writeBatch(db);
                        newData.forEach((p, idx) => {
                            const ref = doc(db, 'artifacts', appId, 'public', 'data', 'participants', `p_${idx}`);
                            addBatch.set(ref, p);
                        });
                        await addBatch.commit();
                        await loadGlobalData();

                        document.getElementById('upload-msg').innerHTML = `<span class="text-[#00A97A]">✓ ${newData.length} participants synced!</span>`;
                        setTimeout(() => {
                            document.getElementById('upload-msg').innerHTML = '';
                        }, 3000);
                    } catch (error) {
                        console.error('Upload error:', error);
                        document.getElementById('upload-msg').innerHTML = '<span class="text-rose-500">Upload failed</span>';
                    }
                }
            };
            reader.readAsText(file);
        };

        // Initialize icons
        lucide.createIcons();
    </script>
</body>

</html>
