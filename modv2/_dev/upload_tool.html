<!DOCTYPE html>
<html>

<head>
    <title>Data Upload Tool</title>
</head>

<body>
    <h1>Uploading Data...</h1>
    <div id="status">Starting...</div>
    <script type="module">
        import { batchUploadParticipants } from './js/services.js';
        import { parseCSVLine, sanitizePhoneNumber } from './js/utils.js';

        async function runUpload() {
            try {
                document.getElementById('status').innerText = "Fetching CSV...";
                const response = await fetch('participants_data.csv');
                if (!response.ok) throw new Error("Failed to fetch CSV: " + response.statusText);
                const text = await response.text();

                document.getElementById('status').innerText = "Parsing CSV...";
                const lines = text.split('\n');

                // Use simple robust parsing based on app.js logic
                const headers = parseCSVLine(lines[0]).map(h => h.trim().replace(/^\uFEFF/, ''));
                const getIdx = (name) => {
                    const idx = headers.findIndex(h => h === name.trim());
                    return idx === -1 ? null : idx;
                };

                const newData = [];
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    const cols = parseCSVLine(line);
                    const p = {
                        name: cols[getIdx('이름')] || cols[0] || '',
                        department: cols[getIdx('부서')] || cols[1] || '',
                        phone: sanitizePhoneNumber(cols[getIdx('휴대전화')] || cols[2] || ''),
                        activity_name: cols[getIdx('액티비티')] || cols[3] || '',
                        start_time: cols[getIdx('출발시간')] || cols[4] || '',
                        meeting_point: cols[getIdx('집합장소')] || cols[5] || '',
                        guide_info: cols[getIdx('가이드 정보')] || cols[6] || '',
                        schedule_1: cols[getIdx('일정 1')] || cols[getIdx('일정1')] || cols[7] || '',
                        schedule_2: cols[getIdx('일정 2')] || cols[getIdx('일정2')] || cols[8] || '',
                        schedule_3: cols[getIdx('일정 3')] || cols[9] || '',
                        supplies: cols[getIdx('준비물')] || cols[10] || '',
                        notice: cols[getIdx('주의사항')] || cols[11] || ''
                    };
                    newData.push(p);
                }

                document.getElementById('status').innerText = `Uploading ${newData.length} records...`;
                await batchUploadParticipants(newData);

                document.getElementById('status').innerText = "UPLOAD COMPLETE";
                console.log("UPLOAD COMPLETE");
            } catch (e) {
                document.getElementById('status').innerText = "ERROR: " + e.message;
                console.error(e);
            }
        }

        runUpload();
    </script>
</body>

</html>
